<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoSim 2025: War Update (Finalisation)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Chakra+Petch:wght@400;600;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #0f172a; color: #e2e8f0; user-select: none; }
        h1, h2, h3, .font-military { font-family: 'Black Ops One', cursive; }
        .font-tech { font-family: 'Chakra Petch', sans-serif; }
        
        /* UI Elements */
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        .btn { transition: all 0.2s; transform: scale(1); cursor: pointer; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: linear-gradient(to bottom, #2563eb, #1d4ed8); border-bottom: 4px solid #1e3a8a; }
        .btn-danger { background: linear-gradient(to bottom, #dc2626, #b91c1c); border-bottom: 4px solid #7f1d1d; }
        .btn-success { background: linear-gradient(to bottom, #16a34a, #15803d); border-bottom: 4px solid #14532d; }
        
        /* Stats Bars */
        .stat-bar { height: 12px; border-radius: 4px; overflow: hidden; background-color: #0f172a; border: 1px solid #475569; }
        .stat-bar-fill { height: 100%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Canvas */
        #editorCanvas, #menuFlagCanvas { image-rendering: pixelated; border: 2px solid #475569; cursor: crosshair; background: #000; touch-action: none; }
        
        /* Animations */
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 5px #3b82f6; } 50% { box-shadow: 0 0 20px #3b82f6; } }
        .glow { animation: pulse-glow 2s infinite; }
        .hidden { display: none !important; }
        
        /* S√©lection */
        .selected-target { border: 2px solid #facc15 !important; background-color: rgba(234, 179, 8, 0.2) !important; }
        
        /* Game Over Modal Overlay */
        #modal-overlay { background-color: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <script>
        const FLAG_COLS = 15;
        const FLAG_ROWS = 10;
        const MAX_ACTIONS_PER_TURN = 3;
        const STORAGE_KEY = 'geosim_war_profile_v1';
        const SOLO_SAVE_KEY = 'geosim_war_solo_save_v1';

        const BOT_NAMES = [
            "Empire Romain", "Royaume de France", "Royaume-Uni", "Dynastie Han", 
            "Empire Ottoman", "R√©publique de Venise", "Union Sovi√©tique", 
            "√âtats-Unis", "Empire Inca", "Horde d'Or", "Royaume Zulu", 
            "R√©publique Galactique", "Maison Stark", "Dominion Klingon", 
            "Ligue des Nations", "F√©d√©ration des Plan√®tes", "Le Troisi√®me Reich",
            "Empire Azteque", "Empire Mongol", "Royaume de Prusse", "Le Califat"
        ];
        const BOT_SUFFIXES = ["Alpha", "Beta", "Gamma", "Delta", "Omega", "Zeta", "Prime", "Max", "Neo", "X", "Noir", "Rouge", "Acier", "Fer", "Or"];

        // Profil par d√©faut
        let profile = {
            name: "Nation " + Math.floor(Math.random()*1000),
            flag: new Array(FLAG_COLS * FLAG_ROWS).fill('#ffffff')
        };
        
        // Initial game state structure
        let gameState = { players: {}, logs: [], turn: 0, difficulty: 'normal', isWinner: false, isFinished: false, ultimateWinner: null }; 
        let isMultiplayer = false;
        let myPeerId = 'me';
        let selectedTargetId = null; 
        let isAutoPlaying = false; 

        // Initialiser apr√®s le chargement du DOM
        document.addEventListener('DOMContentLoaded', () => {
            loadProfile();
            renderMenuFlag();
        });

        function loadProfile() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if(saved) {
                try {
                    const parsed = JSON.parse(saved);
                    profile.name = parsed.name || profile.name;
                    profile.flag = parsed.flag || profile.flag;
                } catch(e) {}
            }
            const nameInput = document.getElementById('globalNameInput');
            if(nameInput) nameInput.value = profile.name;
        }

        function saveProfile() {
            profile.name = document.getElementById('globalNameInput').value || "Nation Inconnue";
            localStorage.setItem(STORAGE_KEY, JSON.stringify(profile));
            renderMenuFlag();
        }

        // --- NAVIGATION ---
        function hideAllScreens() {
            ['screen-menu', 'screen-solo', 'screen-multi-lobby', 'screen-multi-game', 'screen-editor'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById('modal-overlay').classList.add('hidden'); // Hide game over modal
        }
        
        function goHome() {
            // Cleanup P2P
            if(multiPeer) { multiPeer.destroy(); multiPeer = null; }
            multiConnections = [];
            isHost = false;
            myPeerId = 'me';
            isMultiplayer = false;
            selectedTargetId = null;
            isAutoPlaying = false;
            
            // If the solo game was marked as finished, clear the save
            if (gameState.isFinished) {
                localStorage.removeItem(SOLO_SAVE_KEY); 
            }
            
            // Global state reset
            gameState = { players: {}, logs: [], turn: 0, difficulty: 'normal', isWinner: false, isFinished: false, ultimateWinner: null };
            
            hideAllScreens();
            document.getElementById('screen-menu').classList.remove('hidden');
            renderMenuFlag();
        }

        // Ajout de la fonction pour quitter la partie solo
        function quitSoloGame() {
            localStorage.removeItem(SOLO_SAVE_KEY);
            goHome();
        }

        // ==================== FLAG EDITOR LOGIC ====================
        let editorCanvas, eCtx;
        let tempFlag = [];

        function openEditor() {
            editorCanvas = document.getElementById('editorCanvas');
            eCtx = editorCanvas.getContext('2d');
            tempFlag = [...profile.flag];
            drawEditor();
            hideAllScreens();
            document.getElementById('screen-editor').classList.remove('hidden');
        }

        function closeEditor(save) {
            if(save) {
                profile.flag = [...tempFlag];
                saveProfile();
            }
            hideAllScreens();
            document.getElementById('screen-menu').classList.remove('hidden');
            renderMenuFlag();
        }

        function drawEditor() {
            if(!eCtx) return;
            const pW = editorCanvas.width / FLAG_COLS;
            const pH = editorCanvas.height / FLAG_ROWS;
            eCtx.clearRect(0, 0, editorCanvas.width, editorCanvas.height);
            for(let i=0; i<tempFlag.length; i++) {
                const c = i % FLAG_COLS;
                const r = Math.floor(i / FLAG_COLS);
                eCtx.fillStyle = tempFlag[i];
                eCtx.fillRect(c*pW, r*pH, pW, pH);
                eCtx.strokeStyle = '#333';
                eCtx.strokeRect(c*pW, r*pH, pW, pH);
            }
        }

        let isDrawing = false;
        let lastPos = {x: -1, y: -1};

        function getCanvasCoords(e) {
            const rect = editorCanvas.getBoundingClientRect();
            let clientX = e.touches ? e.touches[0].clientX : e.clientX;
            let clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const x = Math.floor((clientX - rect.left) / (rect.width/FLAG_COLS));
            const y = Math.floor((clientY - rect.top) / (rect.height/FLAG_ROWS));
            return {x, y};
        }

        function drawPixel(e) {
            if(e.cancelable) e.preventDefault();
            if(!isDrawing) return;
            const {x, y} = getCanvasCoords(e);
            if(x>=0 && x<FLAG_COLS && y>=0 && y<FLAG_ROWS && (x !== lastPos.x || y !== lastPos.y)) {
                tempFlag[y*FLAG_COLS+x] = document.getElementById('editorColor').value;
                drawEditor();
                lastPos = {x, y};
            }
        }
        
        document.addEventListener('pointerdown', (e) => {
            if (e.target.id === 'editorCanvas') {
                isDrawing = true;
                lastPos = {x: -1, y: -1};
                drawPixel(e);
            }
        });
        document.addEventListener('pointerup', () => isDrawing = false);
        document.addEventListener('pointermove', drawPixel);
        
        function clearEditor() { tempFlag.fill('#ffffff'); drawEditor(); }

        function renderMenuFlag() {
            const c = document.getElementById('menuFlagCanvas');
            if (!c) return;
            const ctx = c.getContext('2d');
            drawMiniFlag(ctx, profile.flag, c.width, c.height);
            document.getElementById('globalNameInput').value = profile.name;
        }

        function drawMiniFlag(ctx, flagData, w, h) {
            const pw = w / FLAG_COLS;
            const ph = h / FLAG_ROWS;
            for(let i=0; i<flagData.length; i++) {
                ctx.fillStyle = flagData[i] || '#ffffff';
                ctx.fillRect((i%FLAG_COLS)*pw, Math.floor(i/FLAG_COLS)*pw, pw, ph);
            }
        }

        // ==================== GAME LOGIC (WAR UPDATE) ====================
        function getPlayerById(id) { return gameState.players[id]; }

        function createBot(level) {
            const name = BOT_NAMES[Math.floor(Math.random()*BOT_NAMES.length)] + ' ' + BOT_SUFFIXES[Math.floor(Math.random()*BOT_SUFFIXES.length)];
            const id = 'bot_' + Math.random().toString(36).substr(2, 9);
            
            let stats = { eco: 20, mil: 20, spy: 20, stab: 20 };
            
            let diffMultiplier = 1;
            // Difficulty level adjustment
            if (gameState.difficulty === 'hard') diffMultiplier = 1.5;
            if (gameState.difficulty === 'intense') diffMultiplier = 2.0;
            if (gameState.difficulty === 'insane') diffMultiplier = 3.0; 

            if (level === 'hard') stats = { eco: 40, mil: 40, stab: 30, spy: 40 };
            else if (level === 'normal') stats = { eco: 25, mil: 25, stab: 20, spy: 25 };

            for(let k in stats) stats[k] = Math.min(100, Math.floor(stats[k] * diffMultiplier));

            for(let k in stats) stats[k] = Math.min(100, stats[k] + Math.floor(Math.random() * 10));

            // Personality for bot betrayal
            const personality = Math.random();

            return {
                id: id, name: name,
                flag: new Array(FLAG_COLS * FLAG_ROWS).fill('#'+Math.floor(Math.random()*16777215).toString(16)),
                isBot: true, hp: 100, ...stats,
                actions: MAX_ACTIONS_PER_TURN, alliance: null, alliance_offer: null, 
                bot_level: level, personality: personality
            };
        }

        function addBots(count) {
            const levels = ['easy', 'normal', 'hard']; 
            for(let i=0; i<count; i++) {
                const bot = createBot(levels[i % levels.length]);
                gameState.players[bot.id] = bot;
            }
            logGame(`Syst√®me : ${count} nouveaux bots ajout√©s (Mixte).`);
        }

        function logGame(msg) {
            gameState.logs.push(msg);
            // In a real P2P scenario, only the host should broadcast
            if (isMultiplayer && isHost) broadcastMulti(); 
            // Update the log UI immediately (needed for client in multi)
            if(!isMultiplayer || myPeerId !== 'me') {
                 // Force UI refresh after log
                 if(document.getElementById('screen-solo').classList.contains('hidden')) renderMultiUI(); 
                 else renderSoloUI();
            }
        }

        // ==================== COMMON ACTIONS ====================
        function selectTarget(id) {
            if (id === myPeerId) return; 
            selectedTargetId = (selectedTargetId === id) ? null : id;
            if(isMultiplayer) renderMultiUI(); else renderSoloUI();
        }

        function executeAction(actionType) {
            const me = gameState.players[myPeerId];
            if(!me || me.actions <= 0 || (me.hp <= 0 && actionType !== 'ADD_BOTS')) {
                return; // Cannot perform action if dead/no actions
            }

            let payload = {};
            
            if(['attack', 'sabotage', 'PROPOSE'].includes(actionType)) {
                if(!selectedTargetId) return; // Must select a target
                payload.target = selectedTargetId;
            }
            
            if(actionType === 'RENAME_ALLIANCE') {
                const inputId = isMultiplayer ? 'multiAllianceName' : 'soloAllianceName';
                const newName = document.getElementById(inputId).value;
                if(!newName || newName.trim() === '') return;
                payload.newName = newName;
            }

            if (isMultiplayer) {
                if(isHost) {
                    processMultiActionHost(myPeerId, actionType, payload);
                    broadcastMulti();
                } else {
                    // Send action to host
                    multiConn.send({ type: 'ACTION', action: actionType, payload: payload });
                }
            } else {
                // Solo mode
                if(actionType === 'ADD_BOTS') addBots(3);
                else processSoloAction(actionType, payload);
                renderSoloUI();
                localStorage.setItem(SOLO_SAVE_KEY, JSON.stringify(gameState));
                checkGameOver(); // Check for victory/defeat after every action
            }
        }

        // ==================== GAME CORE LOGIC ====================
        function processSoloAction(type, payload) {
            const me = gameState.players['me']; 
            let target = payload.target ? gameState.players[payload.target] : null;

            if(type === 'eco') { me.eco = Math.min(100, me.eco+5); me.actions--; logGame("Investissement √âco (+5)"); }
            else if(type === 'mil') { me.mil = Math.min(100, me.mil+5); me.actions--; logGame("Recrutement Militaire (+5)"); }
            else if(type === 'stab') { me.stab = Math.min(100, me.stab+5); me.hp = Math.min(100, me.hp+2); me.actions--; logGame("Propagande & Soin (+5 Stab, +2 HP)"); }
            else if(type === 'spy') { me.spy = Math.min(100, me.spy+5); me.actions--; logGame("Renforcement Espionnage (+5)"); }
            
            else if(type === 'attack') {
                if(target && target.hp > 0) {
                    if(target.alliance && target.alliance === me.alliance) { logGame("Tir ami annul√© !"); return; }
                    const dmg = Math.max(5, Math.floor((me.mil*0.6) - (target.mil*0.2)));
                    target.hp = Math.max(0, target.hp - dmg);
                    me.actions--;
                    logGame(`‚öîÔ∏è ${me.name} attaque ${target.name} : -${dmg} HP !`);
                    if(target.hp <= 0) { logGame(`üíÄ ${target.name} a √©t√© AN√âANTI par ${me.name} !`); target.alliance = null; }
                }
            }
            else if(type === 'sabotage') {
                if(target && target.hp > 0) {
                    if(target.alliance && target.alliance === me.alliance) { logGame("Sabotage alli√© annul√© !"); return; }
                    if(Math.random() < (me.spy/100)) {
                        const stat = ['eco','mil','stab'][Math.floor(Math.random()*3)];
                        const loss = 10 + Math.floor(Math.random() * 10); 
                        target[stat] = Math.max(0, target[stat]-loss);
                        logGame(`üí£ ${me.name} a sabot√© ${target.name} (-${loss} ${stat.toUpperCase()}) !`);
                    } else {
                        me.stab = Math.max(0, me.stab-5);
                        logGame(`üö´ Echec du sabotage de ${me.name} sur ${target.name} !`);
                    }
                    me.actions--;
                }
            }
            
            else if(type === 'PROPOSE') {
                if(target && target.hp > 0) {
                    if(target.alliance && target.alliance === me.alliance) { logGame("D√©j√† alli√©s."); return; }
                    target.alliance_offer = me.id;
                    me.actions--;
                    logGame(`üìú ${me.name} propose une alliance √† ${target.name}.`);
                }
            }
            else if(type === 'LEAVE') {
                const oldAlly = me.alliance;
                me.alliance = null;
                logGame(`üíî ${me.name} a quitt√© l'alliance [${oldAlly}].`);
            }
            else if(type === 'RENAME_ALLIANCE') {
                if(me.alliance && payload.newName) {
                    const oldId = me.alliance;
                    // Note: RENAME_ALLIANCE logic is simplified in P2P vs Solo, here we use the Solo version.
                    Object.values(gameState.players).forEach(p => {
                        if(p.alliance === oldId) p.alliance = payload.newName;
                    });
                    logGame(`üì¢ L'alliance [${oldId}] est renomm√©e : [${payload.newName}]`);
                }
            }
            else if(type === 'ACCEPT') {
                const proposer = gameState.players[payload.proposer];
                if(proposer) {
                    const allianceName = me.alliance || proposer.alliance || `Alliance ${me.name.substring(0,3)}-${proposer.name.substring(0,3)}`;
                    me.alliance = allianceName;
                    proposer.alliance = allianceName;
                    me.alliance_offer = null;
                    logGame(`ü§ù ALLIANCE FORM√âE : ${me.name} et ${proposer.name} !`);
                }
            }
            else if(type === 'REJECT') {
                me.alliance_offer = null;
                logGame(`üö´ ${me.name} a refus√© l'offre d'alliance.`);
            }
        }

        // ==================== SOLO ENGINE ====================
        function startSolo() {
            const diff = document.getElementById('difficultySelect').value;
            isMultiplayer = false;
            myPeerId = 'me';
            selectedTargetId = null;
            isAutoPlaying = false; // Important: reset this when starting a new game
            saveProfile(); hideAllScreens();
            document.getElementById('screen-solo').classList.remove('hidden');
            
            const saved = localStorage.getItem(SOLO_SAVE_KEY);
            
            // If the previous game was marked as finished, or no save exists, start a new game
            if(gameState.isFinished || !saved) {
                initSoloGame(diff);
            } else {
                // Otherwise, load the game
                try {
                    gameState = JSON.parse(saved);
                    const me = gameState.players['me'];
                    if(me) { me.name = profile.name; me.flag = profile.flag; }
                    gameState.difficulty = diff;
                    gameState.isFinished = false; // Reset finished flag upon loading
                    gameState.isWinner = false;
                    gameState.ultimateWinner = null;
                } catch(e) { initSoloGame(diff); }
            }
            renderSoloUI();
        }

        function initSoloGame(difficulty) {
            gameState = { turn: 1, players: {}, logs: ["Guerre d√©clar√©e. Difficult√©: " + difficulty], difficulty: difficulty, isWinner: false, isFinished: false, ultimateWinner: null };
            gameState.players['me'] = {
                id: 'me', name: profile.name, flag: profile.flag, isBot: false,
                hp: 100, eco: 20, mil: 20, stab: 20, spy: 20, actions: MAX_ACTIONS_PER_TURN, alliance: null, alliance_offer: null
            };
            addBots(15); 
            localStorage.setItem(SOLO_SAVE_KEY, JSON.stringify(gameState));
        }

        function soloEndTurn() {
            if(isAutoPlaying) return; // Cannot end turn if auto-playing (Spectator Accelerated mode)
            
            const me = gameState.players['me'];
            
            // Player Turn (Income)
            if(me.hp > 0) {
                const inc = 5 + Math.floor(me.eco/10);
                me.eco = Math.min(100, me.eco + inc);
                me.actions = MAX_ACTIONS_PER_TURN;
                logGame(`=== TOUR ${gameState.turn} (Revenus) ===`);
            } else if (me.hp <= 0) {
                // Spectator mode turn (no player income/actions reset)
                logGame(`=== TOUR ${gameState.turn} (Spectateur) ===`);
            }
            
            gameState.turn++;
            
            // Bot Turn
            runBotAI();
            
            renderSoloUI();
            localStorage.setItem(SOLO_SAVE_KEY, JSON.stringify(gameState));
            checkGameOver();
        }

        function runBotAI() {
            const allPlayers = Object.values(gameState.players).filter(p => p.hp > 0);
            
            Object.values(gameState.players).forEach(bot => {
                if(!bot.isBot || bot.hp <= 0) return;

                bot.actions = MAX_ACTIONS_PER_TURN;
                
                // Bot accepting alliances
                if(bot.alliance_offer) {
                    const proposer = gameState.players[bot.alliance_offer];
                    // Accept if proposer is strong or bot is weak (or random chance)
                    if(proposer && (proposer.mil > bot.mil || bot.hp < 30 || Math.random() > 0.5)) {
                        const allianceName = bot.alliance || proposer.alliance || `Alliance ${bot.name.substring(0,3)}-${proposer.name.substring(0,3)}`;
                        bot.alliance = allianceName; 
                        if(proposer.hp > 0) proposer.alliance = allianceName; // Only set if proposer is still alive
                        logGame(`ü§ù ${bot.name} rejoint l'alliance de ${proposer.name}`);
                    } else {
                         logGame(`üö´ ${bot.name} refuse l'offre d'alliance de ${proposer.name}`);
                    }
                    bot.alliance_offer = null;
                }

                // Bot betrayal (based on personality)
                if(bot.alliance && Math.random() < (bot.personality * 0.2 * (bot.hp < 50 ? 2 : 1))) { // Higher chance if weak
                    const old = bot.alliance;
                    bot.alliance = null;
                    logGame(`üíî TRAHISON ! ${bot.name} quitte l'alliance [${old}] !`);
                }

                for(let i=0; i<bot.actions; i++) {
                    // Targets are all non-allied, non-self, alive players
                    const targets = allPlayers.filter(p => p.id !== bot.id && p.alliance !== bot.alliance);
                    // Potential allies are non-allied, non-self, alive players without a current offer
                    const potentialAllies = allPlayers.filter(p => p.id !== bot.id && !p.alliance && !p.alliance_offer && p.isBot);

                    // Bot attempts to form an alliance with another bot (less likely with player)
                    if(potentialAllies.length > 0 && Math.random() < 0.05 && !bot.alliance) {
                        const ally = potentialAllies[Math.floor(Math.random()*potentialAllies.length)];
                        ally.alliance_offer = bot.id;
                        logGame(`üìú ${bot.name} propose une alliance √† ${ally.name}.`);
                    }
                    // Bot attacks
                    else if(targets.length > 0 && (Math.random() < (0.3 + (bot.bot_level === 'hard' ? 0.3 : 0)))) {
                        const t = targets[Math.floor(Math.random()*targets.length)];
                        const dmg = Math.max(5, Math.floor((bot.mil*0.6) - (t.mil*0.2))) + (gameState.difficulty === 'insane' ? 10 : 0);
                        t.hp = Math.max(0, t.hp - dmg);
                        if(t.id === 'me' || t.hp <= 0) logGame(`‚öîÔ∏è ${bot.name} attaque ${t.name} (-${dmg} HP)`);
                        if(t.hp <= 0) { logGame(`üíÄ ${t.name} √©limin√© par ${bot.name}`); t.alliance = null; }
                    }
                    // Bot develops stats
                    else {
                        const roll = Math.random();
                        if(roll < 0.3) bot.eco = Math.min(100, bot.eco+5);
                        else if(roll < 0.6) bot.mil = Math.min(100, bot.mil+5);
                        else if(roll < 0.8) bot.stab = Math.min(100, bot.stab+5);
                        else bot.spy = Math.min(100, bot.spy+5);
                    }
                }
            });
        }

        function checkGameOver() {
            const me = gameState.players[myPeerId];
            if(!me || gameState.isFinished) return;

            // Filtrer tous les joueurs encore en vie (joueurs ET bots)
            const alivePlayers = Object.values(gameState.players).filter(p => p.hp > 0);
            
            // 1. D√©faite du joueur (uniquement si le joueur n'est pas d√©j√† en mode spectateur)
            if(me.hp <= 0 && !isAutoPlaying && !gameState.isFinished) {
                showGameOverModal(false); // Propose le mode Spectateur
                return;
            }
            
            // 2. V√©rification de la Victoire Universelle (Un seul survivant/alliance)
            
            // Identifier les alliances encore en jeu (noms d'alliances non-nuls)
            // On s'assure qu'un joueur sans alliance est consid√©r√© comme une alliance de "null" pour la v√©rification
            const survivingAllianceNames = [...new Set(alivePlayers.map(p => p.alliance).filter(Boolean))];
            
            let winnerFound = false;
            let ultimateWinnerName = null;
            
            if (alivePlayers.length === 0) return; // Cas impossible ou d'√©galit√©

            // A. Cas d'un seul survivant (Player ou Bot)
            if (alivePlayers.length === 1 && survivingAllianceNames.length === 0) {
                ultimateWinnerName = alivePlayers[0].name;
                winnerFound = true;
            } 
            // B. Cas d'une seule alliance survivante (plusieurs membres mais tous dans la m√™me alliance)
            else if (survivingAllianceNames.length === 1 && alivePlayers.every(p => p.alliance === survivingAllianceNames[0])) {
                ultimateWinnerName = `L'Alliance [${survivingAllianceNames[0]}]`;
                winnerFound = true;
            }

            
            if (winnerFound) {
                gameState.ultimateWinner = ultimateWinnerName; // Stocker le nom du vainqueur
                gameState.isWinner = true;
                
                // Si le joueur est mort mais qu'un vainqueur final est d√©sign√©, on termine la simulation
                if (me.hp <= 0) {
                    isAutoPlaying = false;
                    gameState.isFinished = true;
                    showFinalResultModal(ultimateWinnerName); 
                } else {
                    // Si le joueur est le vainqueur ou fait partie de l'alliance gagnante
                    if (isMultiplayer) renderMultiUI(); else renderSoloUI(); // Show "TERMINER PARTIE" button
                }
            }
        }

        // Display DEFEAT modal (Spectator offered)
        function showGameOverModal(win) { 
            gameState.isFinished = true;
            const modal = document.getElementById('modal-overlay');
            const title = document.getElementById('modal-title');
            const msg = document.getElementById('modal-msg');
            const btnAction = document.getElementById('modal-btn-action');
            const btnAccelerate = document.getElementById('modal-btn-accelerate'); // New button
            const btnReload = document.getElementById('modal-btn-reload');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            title.textContent = "D√âFAITE";
            title.className = "text-4xl font-military text-red-600 mb-4";
            msg.textContent = "Votre nation a √©t√© d√©truite. Voulez-vous suivre la simulation jusqu'√† la fin ?";
            
            btnAction.textContent = "SPECTATEUR (Tour par Tour)";
            btnAction.onclick = startSpectatorModeManual;

            btnAccelerate.textContent = "SPECTATEUR (Acc√©l√©rer)";
            btnAccelerate.onclick = startSpectatorModeAuto;
            btnAccelerate.classList.remove('hidden'); // Show accelerate button

            btnReload.textContent = "Menu Principal";
            btnReload.onclick = goHome;
            btnReload.classList.remove('hidden');
        }

        // Function called when the player clicks "TERMINER PARTIE" (Victory)
        function finalizeVictory() {
            localStorage.removeItem(SOLO_SAVE_KEY); 
            gameState.isFinished = true; 

            showFinalResultModal(gameState.ultimateWinner);
        }

        function startSpectatorModeManual() {
            document.getElementById('modal-overlay').classList.add('hidden');
            isAutoPlaying = false;
            // The player is now in spectator mode, but controls the turn flow manually
            renderSoloUI();
        }

        function startSpectatorModeAuto() {
            document.getElementById('modal-overlay').classList.add('hidden');
            isAutoPlaying = true;
            autoPlayLoop();
        }

        // Display SIMULATION END modal (after spectator mode)
        function showFinalResultModal(winnerName) {
            const modal = document.getElementById('modal-overlay');
            const title = document.getElementById('modal-title');
            const msg = document.getElementById('modal-msg');
            const btnAction = document.getElementById('modal-btn-action');
            const btnAccelerate = document.getElementById('modal-btn-accelerate'); // Hide accelerate button
            const btnReload = document.getElementById('modal-btn-reload');

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            title.textContent = gameState.ultimateWinner === gameState.players[myPeerId]?.name || gameState.ultimateWinner?.includes(gameState.players[myPeerId]?.alliance) ? "VICTOIRE ABSOLUE !" : "SIMULATION TERMIN√âE";
            title.className = gameState.ultimateWinner === gameState.players[myPeerId]?.name || gameState.ultimateWinner?.includes(gameState.players[myPeerId]?.alliance) ? "text-4xl font-military text-yellow-400 mb-4" : "text-4xl font-military text-blue-400 mb-4";
            msg.innerHTML = `<p class="mb-4">Le vainqueur final est :</p><p class="text-2xl font-bold text-white">${winnerName}</p>`;
            
            btnAction.textContent = "Accueil";
            btnAction.onclick = goHome;
            btnAccelerate.classList.add('hidden'); // Cache le bouton d'acc√©l√©ration
            
            btnReload.textContent = "Nouvelle Partie";
            btnReload.onclick = () => { localStorage.removeItem(SOLO_SAVE_KEY); goHome(); startSolo(); };
            btnReload.classList.remove('hidden'); 
        }

        function autoPlayLoop() {
            if(!isAutoPlaying) return;
            
            runBotAI();
            gameState.turn++;
            renderSoloUI();
            
            // Check for game over condition inside the loop
            checkGameOver();
            
            // If the game is finished (winner found), stop the loop
            if(gameState.isFinished) return;
            
            setTimeout(autoPlayLoop, 50); // Accelerated loop (20 turns/sec)
        }

        function renderSoloUI() {
            const me = gameState.players['me'];
            if(!me) return; 

            // --- STANDARD UI UPDATE ---
            document.getElementById('soloHeaderName').textContent = me.name + (me.alliance ? ` [${me.alliance}]` : "") + (me.hp<=0 ? " (MORT)" : "");
            document.getElementById('soloTurn').textContent = gameState.turn;
            
            ['Hp','Eco','Mil','Stab','Spy'].forEach(s => {
                const val = Math.floor(me[s.toLowerCase()]);
                const elVal = document.getElementById(`solo${s}Val`);
                const elBar = document.getElementById(`solo${s}Bar`);
                if(elVal) elVal.textContent = val;
                if(elBar) elBar.style.width = val + '%';
            });
            document.getElementById('soloActions').textContent = me.actions + " Actions";
            document.getElementById('soloLog').innerHTML = gameState.logs.slice(-8).map(l => `<div>> ${l}</div>`).join('');

            // Ranking List & Targeting
            const list = document.getElementById('soloRanking');
            list.innerHTML = '';
            
            Object.values(gameState.players).sort((a,b) => b.hp - a.hp).forEach(p => {
                const div = document.createElement('div');
                const isSelected = (p.id === selectedTargetId);
                div.className = `p-2 flex items-center gap-2 cursor-pointer transition border ${isSelected ? 'selected-target' : 'border-transparent hover:bg-slate-800'}`;
                div.onclick = () => selectTarget(p.id);
                
                const cvs = document.createElement('canvas'); cvs.width=30; cvs.height=20;
                drawMiniFlag(cvs.getContext('2d'), p.flag, 30, 20);
                div.appendChild(cvs);
                
                let info = p.name;
                if(p.alliance) info += ` <span class='text-green-400'>[${p.alliance}]</span>`;
                if(p.isBot && p.hp > 0) info += ` <span class='text-gray-500 text-xs'>(${p.bot_level})</span>`;
                if(isSelected) info += ` <span class='text-yellow-400 font-bold ml-2'><<</span>`;
                
                div.innerHTML += `<div class="flex-1 text-sm ${p.hp<=0?'text-red-500 line-through':'text-white'}">${info}</div><div class="text-xs text-gray-400">${p.hp}%</div>`;
                list.appendChild(div);
            });

            // Alliance UI
            const allyDiv = document.getElementById('soloAllianceUI');
            if(me.alliance_offer) {
                const p = gameState.players[me.alliance_offer];
                allyDiv.innerHTML = `<div class="text-yellow-400 text-center mb-2">Demande de ${p?p.name:'?'}</div>
                <div class="flex gap-2"><button onclick="executeAction('ACCEPT',{proposer:'${me.alliance_offer}'}); renderSoloUI();" class="btn btn-success flex-1 py-1 rounded">Accepter</button>
                <button onclick="executeAction('REJECT',{}); renderSoloUI();" class="btn btn-danger flex-1 py-1 rounded">Refuser</button></div>`;
            } else if(me.alliance) {
                allyDiv.innerHTML = `<input id="soloAllianceName" class="w-full bg-slate-900 p-1 mb-2 text-sm border border-gray-600" placeholder="Renommer Alliance" value="${me.alliance}">
                <div class="flex gap-2"><button onclick="executeAction('RENAME_ALLIANCE')" class="btn btn-primary flex-1 py-1 rounded text-xs">Renommer</button>
                <button onclick="executeAction('LEAVE')" class="btn btn-danger flex-1 py-1 rounded text-xs">Quitter</button></div>`;
            } else {
                allyDiv.innerHTML = `<div class="text-gray-500 text-xs text-center">S√©lectionnez un joueur pour proposer/rejoindre.</div>`;
            }
            
            // --- VICTORY & SPECTATOR BUTTON MANAGEMENT ---
            const btnFinish = document.getElementById('btnSoloFinish');
            const btnEndTurn = document.getElementById('btnSoloEndTurn');
            const btnAddBots = document.getElementById('btnSoloAddBots');
            const btnQuit = document.getElementById('btnSoloQuit'); // New Quit button

            // A. Victory
            if (gameState.isWinner) {
                btnFinish.classList.remove('hidden');
                btnEndTurn.classList.add('hidden');
                btnAddBots.classList.add('hidden');
                btnQuit.classList.add('hidden');
            } 
            // B. Defeat / Spectator Mode
            else if (me.hp <= 0) {
                 btnFinish.classList.add('hidden');
                 btnEndTurn.classList.remove('hidden');
                 btnEndTurn.textContent = isAutoPlaying ? "ACC√âL√âRATION (EN COURS)" : "Tour Suivant üåô";
                 btnEndTurn.disabled = isAutoPlaying;
                 btnEndTurn.classList.toggle('opacity-50', isAutoPlaying);
                 btnAddBots.classList.add('hidden'); 
                 btnQuit.classList.remove('hidden');
            }
            // C. In-Game
            else {
                btnFinish.classList.add('hidden');
                btnEndTurn.classList.remove('hidden');
                btnEndTurn.textContent = "Fin Tour üåô";
                btnEndTurn.disabled = false;
                btnEndTurn.classList.remove('opacity-50');
                btnAddBots.classList.remove('hidden');
                btnQuit.classList.remove('hidden');
            }


            // Disable standard actions if no actions left or dead or game won
            const disableActions = me.actions <= 0 || me.hp <= 0 || gameState.isWinner;

            const targetBtnIds = ['btnSoloAtt', 'btnSoloSab', 'btnSoloAlly'];
            targetBtnIds.forEach(id => {
                const btn = document.getElementById(id);
                if(btn) {
                    // Disable if no target OR disable condition is met
                    const isDisabled = !selectedTargetId || disableActions; 
                    btn.disabled = isDisabled;
                    btn.classList.toggle('opacity-50', isDisabled);
                }
            });
        }

        // ==================== MULTI ENGINE (P2P) ====================
        
        let multiPeer = null, multiConn = null, multiConnections = [], isHost = false;

        function openMultiLobby() {
            const diff = document.getElementById('difficultySelect').value;
            isMultiplayer = true; saveProfile(); hideAllScreens();
            document.getElementById('screen-multi-lobby').classList.remove('hidden');
            document.getElementById('multiHostArea').classList.add('hidden');
            document.getElementById('multiJoinArea').classList.add('hidden');
            gameState.difficulty = diff; 
        }
        function showJoinInput() { document.getElementById('multiJoinArea').classList.remove('hidden'); }
        
        function initPeer(host) {
            isHost = host;
            // Peer ID generation (GEO-XXXX)
            multiPeer = new Peer(host ? 'GEO-'+Math.floor(Math.random()*10000) : null);
            multiPeer.on('open', id => {
                myPeerId = id;
                if(host) {
                    // Initialize game state with host's profile
                    gameState = { turn: 0, players: {}, logs: ["Lobby cr√©√©."], difficulty: gameState.difficulty, isWinner: false, isFinished: false, ultimateWinner: null };
                    gameState.players[id] = { id, name: profile.name, flag: profile.flag, isBot: false, hp:100, eco:20, mil:20, stab:20, spy:20, actions:0, alliance:null };
                    addBots(15); 
                    document.getElementById('multiHostArea').classList.remove('hidden');
                    document.getElementById('multiCodeDisplay').textContent = id;
                    renderMultiUI();
                    document.getElementById('multiAddBotBtn').classList.remove('hidden'); // Bot button visible for host
                } else {
                    // Joining a game
                    const code = document.getElementById('multiHostInput').value;
                    if(!code) return;
                    multiConn = multiPeer.connect(code);
                    setupConn(multiConn);
                }
            });
            multiPeer.on('connection', c => { if(isHost) { setupConn(c); multiConnections.push(c); } });
            multiPeer.on('error', err => console.error("PeerJS Error:", err)); // Basic error handling
        }

        function setupConn(c) {
            c.on('open', () => {
                if(isHost) { 
                    c.send({type:'STATE', state:gameState}); 
                } else { 
                    // Send player profile to host
                    c.send({type:'HELLO', name:profile.name, flag:profile.flag});
                    document.getElementById('screen-multi-lobby').classList.add('hidden');
                    document.getElementById('screen-multi-game').classList.remove('hidden');
                }
            });
            c.on('data', d => {
                if(isHost) {
                    if(d.type==='HELLO') {
                        // New player joining
                        gameState.players[c.peer] = { id:c.peer, name:d.name, flag:d.flag, isBot:false, hp:100, eco:20, mil:20, stab:20, spy:20, actions:0, alliance:null }; // 0 actions until game starts
                        logGame(`üì¢ ${d.name} a rejoint la partie.`);
                        broadcastMulti();
                    } else if(d.type==='ACTION') {
                        // Player action received
                        processMultiActionHost(c.peer, d.action, d.payload); 
                        broadcastMulti();
                    }
                } else {
                    // Client receiving state from host
                    if(d.type==='STATE') { 
                        gameState = d.state; 
                        // Set the player's name/flag if they are in the game
                        const me = gameState.players[myPeerId];
                        if(me) { me.name = profile.name; me.flag = profile.flag; } 
                        renderMultiUI(); 
                        checkGameOver(); 
                    }
                }
            });
            c.on('close', () => {
                 if(isHost) {
                     // Handle disconnection on host side
                     logGame(`üö´ ${gameState.players[c.peer]?.name || c.peer} s'est d√©connect√©.`);
                     multiConnections = multiConnections.filter(conn => conn.peer !== c.peer);
                     // Set the player's HP to 0 upon disconnection
                     if(gameState.players[c.peer]) gameState.players[c.peer].hp = 0;
                     broadcastMulti(); 
                 } else {
                     // Handle disconnection on client side
                     goHome();
                 }
            });
        }

        function startMultiGame() {
            if(!isHost) return;
            gameState.turn = 1;
            Object.values(gameState.players).forEach(p => p.actions = MAX_ACTIONS_PER_TURN);
            document.getElementById('screen-multi-lobby').classList.add('hidden');
            document.getElementById('screen-multi-game').classList.remove('hidden');
            logGame("üéÆ La partie a commenc√© !");
            broadcastMulti();
        }

        function broadcastMulti() {
            // Only run bot AI if the game has started (turn > 0)
            if(gameState.turn > 0) {
                 // 1. Host Income/Turn update
                 const me = gameState.players[myPeerId];
                 if(me.hp > 0) {
                    me.eco = Math.min(100, me.eco + 5 + Math.floor(me.eco/10));
                    me.actions = MAX_ACTIONS_PER_TURN;
                    logGame(`=== TOUR ${gameState.turn} (Revenus) ===`);
                 }
                 
                 // 2. Bot Turn
                 runBotAI(); 
                 
                 gameState.turn++;
            }

            const msg = {type:'STATE', state:gameState};
            multiConnections.forEach(c => c.send(msg));
            renderMultiUI();
            checkGameOver();
        }
        
        function processMultiActionHost(id, type, payload) {
            // Note: In multiplayer, the host processes the action for the sending player
            const me = gameState.players[id];
            let target = payload.target ? gameState.players[payload.target] : null;
            
            // Logic identical to Solo's processSoloAction, applied to the player's ID
            if(!me || me.actions <= 0 || me.hp <= 0) return; // Guard for dead/no action

            if(type === 'eco') { me.eco = Math.min(100, me.eco+5); me.actions--; logGame(`${me.name} investit.`); }
            else if(type === 'mil') { me.mil = Math.min(100, me.mil+5); me.actions--; logGame(`${me.name} recrute.`); }
            else if(type === 'stab') { me.stab = Math.min(100, me.stab+5); me.hp = Math.min(100, me.hp+2); me.actions--; logGame(`${me.name} stabilise.`); }
            else if(type === 'spy') { me.spy = Math.min(100, me.spy+5); me.actions--; logGame(`${me.name} espionne.`); }
            else if(type === 'attack' && target) {
                if(target.alliance && target.alliance === me.alliance) { logGame("Tir ami annul√© !"); return; }
                const dmg = Math.max(5, Math.floor((me.mil*0.6) - (target.mil*0.2)));
                target.hp = Math.max(0, target.hp - dmg);
                me.actions--;
                logGame(`‚öîÔ∏è ${me.name} attaque ${target.name} (-${dmg})`);
                if(target.hp <= 0) { logGame(`üíÄ ${target.name} √©limin√© !`); target.alliance = null; }
            }
            else if(type === 'sabotage' && target) {
                if(target.alliance && target.alliance === me.alliance) { logGame("Sabotage alli√© annul√© !"); return; }
                if(Math.random() < (me.spy/100)) {
                    const stat = ['eco','mil','stab'][Math.floor(Math.random()*3)];
                    const loss = 10 + Math.floor(Math.random() * 10); 
                    target[stat] = Math.max(0, target[stat]-loss);
                    logGame(`üí£ ${me.name} a sabot√© ${target.name} (-${loss} ${stat.toUpperCase()}) !`);
                } else {
                    me.stab = Math.max(0, me.stab-5);
                    logGame(`üö´ Echec du sabotage de ${me.name} sur ${target.name} !`);
                }
                me.actions--;
            }
            else if(type === 'PROPOSE' && target) {
                if(target.alliance && target.alliance === me.alliance) { logGame("D√©j√† alli√©s."); return; }
                target.alliance_offer = me.id;
                me.actions--;
                logGame(`üìú ${me.name} invite ${target.name} en alliance.`);
            }
            else if(type === 'ACCEPT' && payload.proposer) {
                const p = gameState.players[payload.proposer];
                const name = me.alliance || p.alliance || `Alliance ${me.name.substring(0,3)}-${p.name.substring(0,3)}`;
                me.alliance = name; 
                if(p && p.hp > 0) p.alliance = name; 
                me.alliance_offer = null;
                logGame(`ü§ù ALLIANCE FORM√âE : ${me.name} et ${p.name} !`);
            }
            else if(type === 'LEAVE') { 
                me.alliance = null; 
                logGame(`üíî ${me.name} quitte son alliance.`); 
            }
            else if(type === 'REJECT') {
                me.alliance_offer = null;
                logGame(`üö´ ${me.name} a refus√© l'offre d'alliance.`);
            }
            else if(type === 'RENAME_ALLIANCE') {
                if(me.alliance && payload.newName) {
                    const oldId = me.alliance;
                    Object.values(gameState.players).forEach(p => {
                        if(p.alliance === oldId) p.alliance = payload.newName;
                    });
                    logGame(`üì¢ L'alliance [${oldId}] est renomm√©e : [${payload.newName}]`);
                }
            }
            else if(type === 'ADD_BOTS') { addBots(3); }
        }

        function renderMultiUI() {
            const me = gameState.players[myPeerId];
            if(!me) return;
            
            document.getElementById('multiMyName').textContent = me.name + (me.alliance ? ` [${me.alliance}]` : "") + (me.hp<=0 ? " (MORT)" : "");
            document.getElementById('multiTurn').textContent = gameState.turn > 0 ? gameState.turn : 'Lobby';
            
            ['Hp','Eco','Mil','Stab','Spy'].forEach(s => {
                const val = Math.floor(me[s.toLowerCase()]);
                const elVal = document.getElementById(`multi${s}Val`);
                const elBar = document.getElementById(`multi${s}Bar`);
                if(elVal) elVal.textContent = val;
                if(elBar) elBar.style.width = val + '%';
            });
            document.getElementById('multiActions').textContent = me.actions;
            
            const list = document.getElementById('multiPlayerList');
            list.innerHTML = '';
            Object.values(gameState.players).sort((a,b)=>b.hp-a.hp).forEach(p => {
                const div = document.createElement('div');
                const isSelected = (p.id === selectedTargetId);
                div.className = `p-2 flex items-center gap-2 border-b border-slate-700 cursor-pointer ${isSelected ? 'selected-target' : ''}`;
                div.onclick = () => selectTarget(p.id);
                const cvs = document.createElement('canvas'); cvs.width=30; cvs.height=20;
                drawMiniFlag(cvs.getContext('2d'), p.flag, 30, 20);
                div.appendChild(cvs);
                div.innerHTML += `<div class="flex-1 text-sm">${p.name} ${p.alliance?`[${p.alliance}]`:''} ${p.hp<=0?'<span class="text-red-500 line-through">(Mort)</span>':''} ${isSelected?'<b class="text-yellow-400"><<</b>':''}</div>`;
                list.appendChild(div);
            });
            
            const allyDiv = document.getElementById('multiAllianceUI');
            if(me.alliance_offer) {
                // If the player has an offer, display accept/reject (assuming it's from the selected target for simplicity in multi UI)
                const proposer = gameState.players[me.alliance_offer];
                allyDiv.innerHTML = `<div class="text-yellow-400 text-center mb-2">Demande de ${proposer?proposer.name:'?'}</div>
                <div class="flex gap-2"><button onclick="executeAction('ACCEPT', {proposer:'${me.alliance_offer}'})" class="btn btn-success flex-1 py-1 rounded text-xs">Accepter</button>
                <button onclick="executeAction('REJECT')" class="btn btn-danger flex-1 py-1 rounded text-xs">Refuser</button></div>`;

            } else if(me.alliance) {
                 allyDiv.innerHTML = `<input id="multiAllianceName" class="w-full bg-slate-800 text-white text-xs p-1 mb-1" value="${me.alliance}">
                 <div class="flex gap-1"><button onclick="executeAction('RENAME_ALLIANCE')" class="btn btn-primary flex-1 text-xs rounded">Nommer</button>
                 <button onclick="executeAction('LEAVE')" class="btn btn-danger flex-1 text-xs rounded">Quitter</button></div>`;
            } else {
                allyDiv.innerHTML = `<div class="text-xs text-gray-500">Solo</div>`;
            }
            
            // Log update
            document.getElementById('multiLog').innerHTML = gameState.logs.slice(-8).map(l => `<div>> ${l}</div>`).join('');


            // --- VICTORY & GAME FLOW BUTTON MANAGEMENT ---
            const btnFinish = document.getElementById('btnMultiFinish');
            const btnEndTurn = document.getElementById('btnMultiEndTurn');
            const btnAddBots = document.getElementById('multiAddBotBtn');
            const btnStart = document.getElementById('btnMultiStart');
            const gameControls = document.getElementById('multiGameControls');

            if (gameState.isWinner) {
                btnFinish.classList.remove('hidden');
                btnEndTurn.classList.add('hidden');
                gameControls.classList.add('hidden'); // Cache toutes les actions
                btnStart.classList.add('hidden');
            } 
            else if (gameState.turn === 0) {
                 btnStart.classList.toggle('hidden', !isHost);
                 btnEndTurn.classList.add('hidden');
                 btnFinish.classList.add('hidden');
                 gameControls.classList.add('hidden'); // Cache toutes les actions
            }
            else {
                btnFinish.classList.add('hidden');
                btnStart.classList.add('hidden');
                gameControls.classList.remove('hidden');

                // Host-only controls
                if(isHost) {
                    btnEndTurn.classList.remove('hidden');
                    btnEndTurn.disabled = false;
                    btnEndTurn.classList.remove('opacity-50');
                    btnAddBots.classList.remove('hidden');
                } else {
                    btnEndTurn.classList.add('hidden');
                    btnAddBots.classList.add('hidden');
                }
            }


            // Disable standard actions if no actions left or dead or game won
            const disableActions = me.actions <= 0 || me.hp <= 0 || gameState.isWinner;
            
            const targetBtnIds = ['btnMultiAtt', 'btnMultiSab', 'btnMultiAlly'];
            targetBtnIds.forEach(id => {
                const btn = document.getElementById(id);
                if(btn) {
                    const isDisabled = !selectedTargetId || disableActions;
                    btn.disabled = isDisabled;
                    btn.classList.toggle('opacity-50', isDisabled);
                }
            });
            
             // Disable end turn button if not host
            if(btnEndTurn) {
                btnEndTurn.disabled = !isHost;
                btnEndTurn.classList.toggle('opacity-50', !isHost);
            }
        }
    </script>

    <div id="modal-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="bg-slate-900 border-2 border-white p-8 rounded-xl text-center max-w-sm w-full shadow-2xl">
            <h2 id="modal-title" class="text-4xl font-military text-white mb-4">FIN DE PARTIE</h2>
            <p id="modal-msg" class="text-gray-300 mb-6">...</p>
            <div class="flex flex-col gap-3">
                <button id="modal-btn-action" class="btn btn-primary py-3 rounded font-bold text-lg">ACTION</button>
                <button id="modal-btn-accelerate" class="btn btn-danger py-2 rounded text-sm text-white">ACC√âL√âRER SIMULATION</button>
                <button id="modal-btn-reload" class="btn bg-slate-700 py-2 rounded text-gray-400 hover:text-white">Nouvelle Partie</button>
            </div>
        </div>
    </div>

    <div id="screen-menu" class="flex-1 flex flex-col items-center justify-center p-4 bg-slate-900 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
        <div class="max-w-md w-full text-center space-y-8">
            <div>
                <h1 class="text-6xl text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300 filter drop-shadow-lg">GEOSIM</h1>
                <p class="text-gray-400 tracking-[0.5em] text-sm mt-2">WAR UPDATE</p>
            </div>
            
            <div class="bg-slate-800 p-2 rounded border border-slate-600">
                <label class="text-xs text-gray-400 uppercase font-bold">Difficult√©</label>
                <select id="difficultySelect" class="w-full bg-slate-900 text-white p-2 rounded mt-1 border border-slate-700 outline-none">
                    <option value="easy">üë∂ Facile</option>
                    <option value="normal" selected>‚öñÔ∏è Normal</option>
                    <option value="hard">‚öîÔ∏è Difficile</option>
                    <option value="intense">üî• Intense</option>
                    <option value="insane">üíÄ D√âMENT</option>
                </select>
            </div>

            <div class="card p-6 border-t-4 border-blue-500">
                <h3 class="text-left text-xs text-blue-400 font-bold mb-2">IDENTIT√â</h3>
                <div class="flex items-center gap-4 mb-4">
                    <canvas id="menuFlagCanvas" width="90" height="60" class="border border-gray-600 shadow-lg"></canvas>
                    <input type="text" id="globalNameInput" onchange="saveProfile()" class="flex-1 bg-slate-800 border border-slate-600 text-white font-bold text-lg p-2 rounded focus:border-blue-500 outline-none" placeholder="Nom du Pays">
                </div>
                <button onclick="openEditor()" class="text-xs text-gray-400 hover:text-white underline">Modifier Drapeau</button>
            </div>
            <div class="space-y-4">
                <button onclick="startSolo()" class="btn btn-primary w-full py-4 rounded-xl text-xl font-black font-tech shadow-xl glow">CAMPAGNE SOLO üë§</button>
                <button onclick="openMultiLobby()" class="btn btn-success w-full py-4 rounded-xl text-xl font-black font-tech shadow-xl">MULTIJOUEUR (P2P) üåê</button>
            </div>
        </div>
    </div>

    <div id="screen-editor" class="hidden fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4">
        <div class="bg-slate-800 p-6 rounded-xl border border-slate-600 max-w-sm w-full text-center">
            <h2 class="text-2xl mb-4 text-white">√âditeur (15x10)</h2>
            <canvas id="editorCanvas" width="300" height="200" class="mx-auto mb-4 w-full shadow-2xl"></canvas>
            <div class="flex justify-center gap-2 mb-4">
                <input type="color" id="editorColor" value="#ff0000" class="h-10 w-10 rounded border-0 cursor-pointer">
                <button onclick="clearEditor()" class="btn bg-gray-600 px-4 py-2 rounded text-white text-sm">Effacer</button>
            </div>
            <div class="flex gap-2">
                <button onclick="closeEditor(false)" class="flex-1 py-3 rounded text-gray-400 bg-slate-700">Annuler</button>
                <button onclick="closeEditor(true)" class="flex-1 btn btn-success py-3 rounded text-white font-bold">SAUVEGARDER</button>
            </div>
        </div>
    </div>

    <div id="screen-solo" class="hidden flex-1 flex flex-col p-2 md:p-4 max-w-6xl mx-auto w-full">
        <header class="flex justify-between items-center mb-4 bg-slate-800 p-3 rounded border border-slate-700">
            <button onclick="goHome()" class="text-xs text-gray-500 hover:text-white">‚óÄ Menu</button>
            <h2 id="soloHeaderName" class="text-xl font-bold text-blue-400">Pays</h2>
            <div class="text-sm text-gray-400">Tour <span id="soloTurn">1</span></div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-full">
            <div class="card p-4 space-y-4 lg:col-span-1">
                <div class="h-4 stat-bar"><div id="soloHpBar" class="stat-bar-fill bg-red-600" style="width: 100%"></div></div>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div>üí∞ <span id="soloEcoVal">20</span> <div class="stat-bar"><div id="soloEcoBar" class="stat-bar-fill bg-blue-600" style="width: 20%"></div></div></div>
                    <div>üõ°Ô∏è <span id="soloMilVal">20</span> <div class="stat-bar"><div id="soloMilBar" class="stat-bar-fill bg-yellow-600" style="width: 20%"></div></div></div>
                    <div>‚öñÔ∏è <span id="soloStabVal">20</span> <div class="stat-bar"><div id="soloStabBar" class="stat-bar-fill bg-green-600" style="width: 20%"></div></div></div>
                    <div>üëÅÔ∏è <span id="soloSpyVal">20</span> <div class="stat-bar"><div id="soloSpyBar" class="stat-bar-fill bg-purple-600" style="width: 20%"></div></div></div>
                </div>
                <div id="soloAllianceUI" class="mt-2 border-t border-slate-700 pt-2"></div>
                <div id="soloLog" class="h-32 bg-black/50 rounded p-2 text-xs font-mono overflow-y-auto text-gray-400 border border-slate-700"></div>
            </div>

            <div class="card p-4 lg:col-span-1 flex flex-col gap-2">
                <div class="text-center mb-2"><span id="soloActions" class="bg-blue-900 text-blue-200 px-2 py-1 rounded text-sm font-bold">Actions</span></div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="executeAction('eco')" class="btn bg-slate-700 p-2 rounded text-xs border-l-2 border-blue-500">Investir</button>
                    <button onclick="executeAction('mil')" class="btn bg-slate-700 p-2 rounded text-xs border-l-2 border-yellow-500">Recruter</button>
                    <button onclick="executeAction('stab')" class="btn bg-slate-700 p-2 rounded text-xs border-l-2 border-green-500">Propagande</button>
                    <button onclick="executeAction('spy')" class="btn bg-slate-700 p-2 rounded text-xs border-l-2 border-purple-500">Espionner</button>
                </div>
                <div class="mt-2 pt-2 border-t border-slate-700 bg-slate-800/50 p-2 rounded text-center">
                    <div class="text-xs text-yellow-500 mb-2">S√âLECTIONNEZ UNE CIBLE</div>
                    <div class="grid grid-cols-3 gap-1">
                        <button id="btnSoloAtt" onclick="executeAction('attack')" class="btn btn-danger py-2 rounded text-xs font-bold opacity-50" disabled>ATTAQUE</button>
                        <button id="btnSoloSab" onclick="executeAction('sabotage')" class="btn bg-red-900 py-2 rounded text-xs font-bold opacity-50" disabled>SABOTAGE</button>
                        <button id="btnSoloAlly" onclick="executeAction('PROPOSE')" class="btn btn-primary py-2 rounded text-xs font-bold opacity-50" disabled>INVITER</button>
                    </div>
                </div>
                <div class="flex gap-1 mt-2">
                    <button id="btnSoloQuit" onclick="quitSoloGame()" class="btn bg-slate-700 flex-1 py-2 rounded text-xs">Quitter & Supprimer</button>
                    <button id="btnSoloAddBots" onclick="executeAction('ADD_BOTS')" class="btn bg-slate-600 flex-1 py-2 rounded text-xs">Bots +3</button>
                    <button id="btnSoloEndTurn" onclick="soloEndTurn()" class="btn bg-slate-800 flex-1 py-2 rounded font-bold border border-slate-600">Fin Tour üåô</button>
                    <button id="btnSoloFinish" onclick="finalizeVictory()" class="btn btn-success flex-1 py-2 rounded font-bold hidden">TERMINER PARTIE üèÜ</button>
                </div>
            </div>

            <div class="card p-0 overflow-hidden lg:col-span-1 flex flex-col max-h-96">
                <div class="bg-slate-800 p-2 text-xs font-bold text-center">MONDE</div>
                <div id="soloRanking" class="flex-1 overflow-y-auto divide-y divide-slate-700 bg-slate-900/50"></div>
            </div>
        </div>
    </div>

    <div id="screen-multi-lobby" class="hidden flex-1 flex flex-col items-center justify-center p-4 bg-slate-900">
        <div class="max-w-md w-full card p-8 border-blue-500 border-2">
            <button onclick="goHome()" class="mb-4 text-xs text-gray-500">‚óÄ Retour</button>
            <h2 class="text-3xl text-center mb-6 text-white font-military">LOBBY P2P</h2>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button onclick="initPeer(true)" class="btn btn-primary p-4 rounded font-bold">CR√âER</button>
                <button onclick="showJoinInput()" class="btn btn-success p-4 rounded font-bold">REJOINDRE</button>
            </div>
            <div id="multiJoinArea" class="hidden mb-4 flex gap-2">
                <input type="text" id="multiHostInput" class="flex-1 bg-slate-800 border border-slate-600 p-3 rounded text-center font-mono uppercase" placeholder="CODE">
                <button onclick="initPeer(false)" class="bg-green-600 px-4 rounded font-bold">GO</button>
            </div>
            <div id="multiHostArea" class="hidden text-center bg-slate-800 p-4 rounded border border-dashed border-slate-600">
                <p class="text-gray-400 text-xs">CODE :</p>
                <div id="multiCodeDisplay" class="text-3xl font-mono font-bold text-blue-400 select-all">...</div>
                <button onclick="startMultiGame()" id="btnMultiStart" class="btn btn-primary w-full mt-4 py-2 rounded font-bold">LANCER</button>
            </div>
        </div>
    </div>

    <div id="screen-multi-game" class="hidden flex-1 flex flex-col p-2 md:p-4 max-w-6xl mx-auto w-full">
        <header class="flex justify-between items-center mb-4 bg-slate-800 p-3 rounded border border-blue-900">
            <h2 class="text-xl font-bold text-blue-400 font-military">MULTI</h2>
            <div class="text-sm text-gray-400">Tour <span id="multiTurn">0</span></div>
            <button onclick="goHome()" class="text-xs text-red-500 underline">Quitter</button>
        </header>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="card p-4 space-y-4 lg:col-span-1 border-l-4 border-blue-500">
                <h3 id="multiMyName" class="font-bold">Moi</h3>
                <div class="h-4 stat-bar"><div id="multiHpBar" class="stat-bar-fill bg-red-600" style="width: 100%"></div></div>
                <div class="grid grid-cols-4 gap-2 text-xs text-center">
                    <div class="bg-slate-800 p-1 rounded">Eco <span id="multiEcoVal">0</span></div>
                    <div class="bg-slate-800 p-1 rounded">Mil <span id="multiMilVal">0</span></div>
                    <div class="bg-slate-800 p-1 rounded">Stab <span id="multiStabVal">0</span></div>
                    <div class="bg-slate-800 p-1 rounded">Spy <span id="multiSpyVal">0</span></div>
                </div>
                <div id="multiAllianceUI" class="mt-2 border-t border-slate-700 pt-2"></div>
                <div id="multiLog" class="h-32 bg-black/50 rounded p-2 text-xs font-mono overflow-y-auto text-green-400 border border-slate-700"></div>
            </div>

            <div id="multiGameControls" class="card p-4 lg:col-span-1 space-y-2">
                <div class="text-right mb-2"><span id="multiActions" class="text-xs font-bold bg-blue-900 px-2 py-1 rounded">Actions</span></div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="executeAction('eco')" class="btn bg-slate-700 p-2 rounded text-xs border-l-2 border-blue-500">Investir</button>
                    <button onclick="executeAction('mil')" class="btn bg-slate-700 p-2 rounded text-xs border-l-2 border-yellow-500">Recruter</button>
                    <button onclick="executeAction('stab')" class="btn bg-slate-700 p-2 rounded text-xs border-l-2 border-green-500">Propagande</button>
                    <button onclick="executeAction('spy')" class="btn bg-slate-700 p-2 rounded text-xs border-l-2 border-purple-500">Espionner</button>
                </div>
                <div class="mt-2 pt-2 border-t border-slate-700 bg-slate-800/50 p-2 rounded text-center">
                    <div class="text-xs text-yellow-500 mb-2">S√âLECTIONNEZ UNE CIBLE</div>
                    <div class="grid grid-cols-3 gap-1">
                        <button id="btnMultiAtt" onclick="executeAction('attack')" class="btn btn-danger py-2 rounded text-xs font-bold opacity-50" disabled>ATTAQUE</button>
                        <button id="btnMultiSab" onclick="executeAction('sabotage')" class="btn bg-red-900 py-2 rounded text-xs font-bold opacity-50" disabled>SABOTAGE</button>
                        <button id="btnMultiAlly" onclick="executeAction('PROPOSE')" class="btn btn-primary py-2 rounded text-xs font-bold opacity-50" disabled>INVITER</button>
                    </div>
                </div>
                <div class="flex gap-1 mt-2">
                    <button onclick="executeAction('ADD_BOTS')" id="multiAddBotBtn" class="hidden btn bg-slate-600 flex-1 py-2 rounded text-xs">Bots +3</button>
                    <button onclick="broadcastMulti()" id="btnMultiEndTurn" class="btn bg-slate-800 flex-1 py-2 rounded font-bold border border-slate-600" disabled>Fin Tour üåô</button>
                    <button id="btnMultiFinish" onclick="finalizeVictory()" class="btn btn-success flex-1 py-2 rounded font-bold hidden">TERMINER PARTIE üèÜ</button>
                </div>
            </div>

            <div class="card p-0 lg:col-span-1 overflow-hidden max-h-96">
                <div class="bg-slate-800 p-2 text-xs font-bold text-center">JOUEURS</div>
                <div id="multiPlayerList" class="divide-y divide-slate-700"></div>
            </div>
        </div>
    </div>
</body>
</html>
