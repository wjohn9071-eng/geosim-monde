<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoSim 2025: Simulation de Pays</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f9ff; }
        .card { background-color: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .stat-bar { height: 12px; border-radius: 9999px; overflow: hidden; background-color: #e2e8f0; }
        .stat-bar-fill { transition: width 0.5s ease-out; height: 100%; }
        #flagCanvas { border: 2px solid #cbd5e1; cursor: crosshair; image-rendering: pixelated; touch-action: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #94a3b8; border-radius: 3px; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen text-slate-800">

    <header class="text-center mb-8">
        <h1 class="text-4xl font-black text-blue-900 tracking-tight">GeoSim 2025</h1>
        <p class="text-lg text-blue-600 font-medium">√âdition Solo & Bots (Mode Vercel)</p>
        <div id="connectionStatus" class="mt-2 inline-block px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-bold">
            Initialisation...
        </div>
    </header>

    <main id="app" class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Colonne 1: Votre Pays -->
        <section class="lg:col-span-1 space-y-6">
            <div id="authStatus" class="card p-6 border-t-4 border-blue-500">
                <h2 class="text-2xl font-bold mb-4">Votre Nation</h2>
                <p id="userIdDisplay" class="text-xs font-mono text-gray-400 mb-4 break-all">ID: ...</p>
                
                <div id="countrySetup" class="space-y-4">
                    <input type="text" id="countryNameInput" placeholder="Nom de votre Pays" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 focus:outline-none font-bold text-lg">
                    <button id="createCountryBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl transition shadow-lg transform active:scale-95">
                        Fonder ma Nation
                    </button>
                    <p id="countryStatus" class="text-sm text-red-500 font-medium"></p>
                </div>

                <!-- Stats Pays (Cach√© au d√©but) -->
                <div id="countryStats" class="hidden space-y-5 mt-4">
                    <div class="text-center pb-4 border-b border-gray-100">
                        <h3 class="text-3xl font-black text-blue-900" id="myCountryName">Pays</h3>
                        <span id="allianceTag" class="inline-block mt-1 px-2 py-0.5 bg-purple-100 text-purple-700 text-xs font-bold rounded">SOLO</span>
                    </div>
                    
                    <p id="conquestStatus" class="text-center font-bold text-red-600 animate-pulse"></p>

                    <!-- Barres de Stats -->
                    <div class="space-y-3">
                        <!-- Sant√© -->
                        <div>
                            <div class="flex justify-between text-sm font-bold mb-1">
                                <span>Sant√© ‚ù§Ô∏è</span>
                                <span id="healthPercent" class="text-red-600">100%</span>
                            </div>
                            <div class="stat-bar"><div id="healthBar" class="stat-bar-fill bg-red-500" style="width: 100%"></div></div>
                        </div>
                        <!-- √âconomie -->
                        <div>
                            <div class="flex justify-between text-sm font-bold mb-1">
                                <span>√âconomie üí∞</span>
                                <span id="economyValue" class="text-blue-600">0</span>
                            </div>
                            <div class="stat-bar"><div id="economyBar" class="stat-bar-fill bg-blue-500" style="width: 0%"></div></div>
                        </div>
                        <!-- Arm√©e -->
                        <div>
                            <div class="flex justify-between text-sm font-bold mb-1">
                                <span>Arm√©e ‚öîÔ∏è</span>
                                <span id="militaryValue" class="text-yellow-600">0</span>
                            </div>
                            <div class="stat-bar"><div id="militaryBar" class="stat-bar-fill bg-yellow-500" style="width: 0%"></div></div>
                        </div>
                        <!-- Stabilit√© -->
                        <div>
                            <div class="flex justify-between text-sm font-bold mb-1">
                                <span>Stabilit√© ‚öñÔ∏è</span>
                                <span id="stabilityValue" class="text-green-600">0</span>
                            </div>
                            <div class="stat-bar"><div id="stabilityBar" class="stat-bar-fill bg-green-500" style="width: 0%"></div></div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-3 rounded-lg text-center">
                        <span class="text-sm text-blue-800 font-bold">Revenu/Tour: +<span id="incomeValue">0</span> üí∞</span>
                    </div>
                </div>
            </div>

            <!-- Alliance -->
            <div id="allianceManagement" class="card p-6 hidden border-t-4 border-purple-500">
                <h3 class="text-xl font-bold text-purple-800 mb-3">Alliances</h3>
                <div class="flex gap-2">
                    <input type="text" id="allianceNameInput" placeholder="Nom Alliance" class="flex-1 p-2 border border-gray-200 rounded-lg">
                    <button id="joinAllianceBtn" class="bg-purple-600 text-white font-bold px-4 py-2 rounded-lg text-sm">Rejoindre</button>
                </div>
                <button id="leaveAllianceBtn" class="w-full mt-2 text-gray-500 text-xs font-bold hover:text-red-500">Quitter l'alliance</button>
            </div>
        </section>

        <!-- Colonne 2: Actions & Drapeau -->
        <section class="lg:col-span-1 space-y-6">
            <!-- Drapeau -->
            <div class="card p-6 text-center">
                <h3 class="text-lg font-bold text-gray-700 mb-3">Drapeau (15x10)</h3>
                <div class="flex justify-center mb-3">
                    <canvas id="flagCanvas" width="300" height="200" class="rounded shadow-sm bg-white"></canvas>
                </div>
                <div class="flex items-center justify-center gap-3 mb-3">
                    <input type="color" id="colorPicker" value="#000000" class="h-10 w-10 rounded cursor-pointer border-0">
                    <button id="clearFlagBtn" class="px-3 py-2 bg-gray-200 rounded font-bold text-sm">Gomme</button>
                    <button id="saveFlagBtn" class="px-4 py-2 bg-blue-600 text-white rounded font-bold text-sm shadow">Sauvegarder</button>
                </div>
            </div>

            <!-- Actions -->
            <div id="countryActions" class="card p-6 hidden border-t-4 border-orange-500">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Actions</h2>
                    <span id="turnCounter" class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs font-bold">1 Action Restante</span>
                </div>

                <div class="grid grid-cols-1 gap-3 mb-4">
                    <button data-action="economy" class="action-btn bg-blue-50 hover:bg-blue-100 border-l-4 border-blue-500 p-3 text-left font-bold text-blue-900 transition">
                        üèóÔ∏è Investir (+5 √âco)
                    </button>
                    <button data-action="stability" class="action-btn bg-green-50 hover:bg-green-100 border-l-4 border-green-500 p-3 text-left font-bold text-green-900 transition">
                        üì¢ Propagande (+5 Stab)
                    </button>
                    <button data-action="military" class="action-btn bg-yellow-50 hover:bg-yellow-100 border-l-4 border-yellow-500 p-3 text-left font-bold text-yellow-900 transition">
                        üõ°Ô∏è Recruter (+5 Mil)
                    </button>
                </div>

                <div class="border-t pt-4 mt-4">
                    <label class="text-xs font-bold text-gray-500 uppercase">Zone de Guerre</label>
                    <select id="attackTarget" class="w-full mt-1 p-2 border rounded bg-gray-50 text-sm mb-2"></select>
                    <button data-action="attack" id="attackBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded shadow transition transform active:scale-95">
                        ‚öîÔ∏è ATTAQUER
                    </button>
                </div>

                <button id="endTurnBtn" class="w-full mt-6 bg-gray-900 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-black transition">
                    PASSER LE TOUR üåô
                </button>
                <p id="actionFeedback" class="mt-2 text-center text-xs font-bold h-4 text-blue-600"></p>
            </div>
        </section>

        <!-- Colonne 3: Classement -->
        <section class="lg:col-span-1">
            <div class="card p-6 h-full max-h-[80vh] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Monde</h2>
                    <span id="botStatus" class="text-xs font-mono text-gray-400">Bots actifs</span>
                </div>
                <div class="overflow-y-auto custom-scrollbar flex-1">
                    <table class="w-full">
                        <thead class="text-xs text-gray-500 bg-gray-50 sticky top-0">
                            <tr>
                                <th class="p-2 text-left">Nation</th>
                                <th class="p-2 text-center">Vie</th>
                                <th class="p-2 text-center">Puissance</th>
                            </tr>
                        </thead>
                        <tbody id="countryList" class="text-sm divide-y divide-gray-100">
                            <!-- Liste ici -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <script>
        // --- MOTEUR DE JEU HYBRIDE (LOCAL/MOCK) ---
        
        // Configuration
        const MAX_STAT = 100;
        const FLAG_COLS = 15;
        const FLAG_ROWS = 10;
        let userId = localStorage.getItem('geosim_userid') || 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('geosim_userid', userId);

        // √âtat du jeu
        let db = { countries: {} };
        let myCountry = null;

        // UI References
        const els = {
            status: document.getElementById('connectionStatus'),
            userId: document.getElementById('userIdDisplay'),
            setup: document.getElementById('countrySetup'),
            stats: document.getElementById('countryStats'),
            actions: document.getElementById('countryActions'),
            alliance: document.getElementById('allianceManagement'),
            nameInput: document.getElementById('countryNameInput'),
            createBtn: document.getElementById('createCountryBtn'),
            endTurnBtn: document.getElementById('endTurnBtn'),
            feedback: document.getElementById('actionFeedback'),
            list: document.getElementById('countryList'),
            targetSelect: document.getElementById('attackTarget'),
            inputs: {
                eco: document.getElementById('economyValue'),
                stab: document.getElementById('stabilityValue'),
                mil: document.getElementById('militaryValue'),
                health: document.getElementById('healthPercent'),
                income: document.getElementById('incomeValue')
            },
            bars: {
                eco: document.getElementById('economyBar'),
                stab: document.getElementById('stabilityBar'),
                mil: document.getElementById('militaryBar'),
                health: document.getElementById('healthBar')
            }
        };

        // --- SYST√àME DE BOTS & SAUVEGARDE ---

        function loadGame() {
            const savedData = localStorage.getItem('geosim_db');
            if (savedData) {
                db = JSON.parse(savedData);
            } else {
                // Initialiser les bots si premi√®re fois
                initBots();
            }
            renderGame();
        }

        function saveGame() {
            localStorage.setItem('geosim_db', JSON.stringify(db));
            renderGame();
        }

        function initBots() {
            const botNames = ["Empire Alpha", "R√©publique Beta", "Royaume Gamma", "F√©d√©ration Delta", "Union Omega"];
            const colors = [['#ff0000', '#ffffff'], ['#0000ff', '#ffff00'], ['#00ff00', '#000000'], ['#800080', '#ffa500'], ['#00ffff', '#ff00ff']];
            
            botNames.forEach((name, idx) => {
                const botId = 'bot_' + idx;
                // G√©n√©rer drapeau simple
                let flag = [];
                for(let i=0; i<FLAG_ROWS*FLAG_COLS; i++) flag.push((i%2===0) ? colors[idx][0] : colors[idx][1]);

                db.countries[botId] = {
                    id: botId,
                    name: name,
                    isBot: true,
                    flag: JSON.stringify(flag),
                    economy: 20 + Math.floor(Math.random()*30),
                    stability: 30 + Math.floor(Math.random()*30),
                    military: 10 + Math.floor(Math.random()*40),
                    health: 100,
                    actionsLeft: 1,
                    alliance: null
                };
            });
            saveGame();
        }

        function runBots() {
            Object.values(db.countries).forEach(bot => {
                if (!bot.isBot || bot.health <= 0) return;

                // IA Simple
                if (bot.health < 50) {
                    bot.military += 5; // Panique militaire
                } else if (bot.economy < 40) {
                    bot.economy += 5;
                } else if (bot.military > 50 && Math.random() > 0.7) {
                    // Attaque al√©atoire
                    const targets = Object.values(db.countries).filter(c => c.id !== bot.id && c.health > 0);
                    if (targets.length > 0) {
                        const target = targets[Math.floor(Math.random() * targets.length)];
                        const dmg = Math.max(5, (bot.military * 0.4) - (target.military * 0.2));
                        target.health = Math.max(0, Math.round(target.health - dmg));
                        console.log(`${bot.name} attaque ${target.name}`);
                    }
                } else {
                    // Investissement normal
                    if (Math.random() > 0.5) bot.economy += 5;
                    else bot.stability += 5;
                }

                // Cap stats
                bot.economy = Math.min(100, bot.economy);
                bot.stability = Math.min(100, bot.stability);
                bot.military = Math.min(100, bot.military);
            });
            saveGame();
        }

        // --- UI & INTERACTION ---

        function renderGame() {
            // 1. Mon Pays
            myCountry = db.countries[userId];
            
            if (myCountry) {
                els.setup.classList.add('hidden');
                els.stats.classList.remove('hidden');
                els.actions.classList.remove('hidden');
                els.alliance.classList.remove('hidden');
                
                document.getElementById('myCountryName').textContent = myCountry.name;
                els.userId.textContent = `ID: ${userId}`;
                
                // Stats Update
                updateStat('eco', myCountry.economy, 'blue');
                updateStat('stab', myCountry.stability, 'green');
                updateStat('mil', myCountry.military, 'yellow');
                
                // Health
                els.inputs.health.textContent = myCountry.health + '%';
                els.bars.health.style.width = myCountry.health + '%';
                
                if(myCountry.health <= 0) {
                    document.getElementById('conquestStatus').textContent = "‚ò†Ô∏è NATION D√âTRUITE ‚ò†Ô∏è";
                    els.actions.classList.add('opacity-50', 'pointer-events-none');
                } else {
                    document.getElementById('conquestStatus').textContent = "";
                    els.actions.classList.remove('opacity-50', 'pointer-events-none');
                }

                // Actions
                document.getElementById('turnCounter').textContent = `${myCountry.actionsLeft} Action(s)`;
                els.endTurnBtn.disabled = myCountry.actionsLeft > 0;
                els.endTurnBtn.classList.toggle('opacity-50', myCountry.actionsLeft > 0);
                
                document.querySelectorAll('.action-btn').forEach(btn => {
                    btn.disabled = myCountry.actionsLeft <= 0;
                    btn.classList.toggle('opacity-50', myCountry.actionsLeft <= 0);
                });

                // Income
                els.inputs.income.textContent = 10 + Math.floor(myCountry.economy / 10);
                
                // Drapeau
                loadFlag(myCountry.flag);
                
                // Alliance
                document.getElementById('allianceTag').textContent = myCountry.alliance || 'SOLO';
            } else {
                els.setup.classList.remove('hidden');
                els.stats.classList.add('hidden');
                els.actions.classList.add('hidden');
                els.alliance.classList.add('hidden');
            }

            // 2. Liste & Cibles
            els.list.innerHTML = '';
            els.targetSelect.innerHTML = '';
            
            const sorted = Object.values(db.countries).sort((a,b) => (b.economy+b.military) - (a.economy+a.military));
            
            sorted.forEach(c => {
                // Liste
                const tr = document.createElement('tr');
                const isMe = c.id === userId;
                tr.className = isMe ? "bg-blue-50 font-bold border-l-4 border-blue-500" : "";
                
                // Mini drapeau
                let flagCanvas = document.createElement('canvas');
                flagCanvas.width = 30; flagCanvas.height = 20;
                drawTinyFlag(flagCanvas, c.flag);

                tr.innerHTML = `
                    <td class="p-2 flex items-center gap-2">
                        <div class="w-8 h-5 border bg-gray-200">${flagCanvas.outerHTML}</div>
                        <div>
                            <div class="${c.health<=0 ? 'line-through text-red-400' : 'text-gray-800'}">${c.name}</div>
                            <div class="text-[10px] text-gray-400">${c.isBot ? 'ü§ñ BOT' : 'üë§ JOUEUR'}</div>
                        </div>
                    </td>
                    <td class="p-2 text-center font-bold ${c.health<30 ? 'text-red-600' : 'text-green-600'}">${c.health}%</td>
                    <td class="p-2 text-center font-bold text-gray-600">${c.military}</td>
                `;
                els.list.appendChild(tr);

                // Select Attack (Pas soi-m√™me, pas morts, pas alli√©s)
                if (!isMe && c.health > 0) {
                    if (myCountry && myCountry.alliance && myCountry.alliance === c.alliance) return;
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = `‚öîÔ∏è ${c.name} (Mil: ${c.military})`;
                    els.targetSelect.appendChild(opt);
                }
            });
            
            // Redessiner les drapeaux dans la liste (petit hack car outerHTML perd le contexte)
            setTimeout(() => {
                const rows = els.list.querySelectorAll('tr');
                rows.forEach((row, idx) => {
                    const country = sorted[idx];
                    const canvas = row.querySelector('canvas'); // Il n'y en a pas dans le HTML stringifi√© tel quel
                    // Pour simplifier, on ne redessine pas les canvas dans la liste dans cette version simple pour √©viter complexit√©
                });
            }, 0);
        }

        function updateStat(key, val, color) {
            els.inputs[key].textContent = val;
            els.bars[key].style.width = val + '%';
        }

        // --- LOGIQUE JEU ---

        els.createBtn.addEventListener('click', () => {
            const name = els.nameInput.value.trim();
            if(!name) return;
            
            // Init Flag
            let flag = [];
            for(let i=0; i<FLAG_ROWS*FLAG_COLS; i++) flag.push('#ffffff');

            db.countries[userId] = {
                id: userId,
                name: name,
                isBot: false,
                flag: JSON.stringify(flag),
                economy: 20, stability: 20, military: 20, health: 100,
                actionsLeft: 1, alliance: null
            };
            saveGame();
        });

        // Actions Boutons
        document.querySelectorAll('.action-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                if(myCountry.actionsLeft <= 0) return;
                const act = e.target.getAttribute('data-action') || e.target.parentElement.getAttribute('data-action');
                
                if(act === 'economy') myCountry.economy += 5;
                if(act === 'stability') myCountry.stability += 5;
                if(act === 'military') myCountry.military += 5;

                // Cap 100
                myCountry.economy = Math.min(100, myCountry.economy);
                myCountry.stability = Math.min(100, myCountry.stability);
                myCountry.military = Math.min(100, myCountry.military);

                myCountry.actionsLeft--;
                feedback("Action effectu√©e !");
                saveGame();
            });
        });

        els.endTurnBtn.addEventListener('click', () => {
            // Revenu
            const income = 10 + Math.floor(myCountry.economy / 10);
            const stabPenalty = myCountry.stability < 20 ? 10 : 0;
            
            myCountry.economy = Math.max(0, Math.min(100, myCountry.economy + income - stabPenalty));
            myCountry.actionsLeft = 1;
            
            feedback(`Tour termin√©. Revenu: +${income}`);
            
            // Tour des bots
            runBots();
            saveGame();
        });

        document.getElementById('attackBtn').addEventListener('click', () => {
            if(myCountry.actionsLeft <= 0) return;
            const targetId = els.targetSelect.value;
            if(!targetId) return;
            
            const target = db.countries[targetId];
            const dmg = Math.max(5, (myCountry.military * 0.5) - (target.military * 0.3));
            
            target.health = Math.max(0, Math.round(target.health - dmg));
            myCountry.actionsLeft--;
            
            feedback(`Attaque sur ${target.name} ! -${Math.round(dmg)} PV`);
            saveGame();
        });

        // Alliance
        document.getElementById('joinAllianceBtn').addEventListener('click', () => {
            const name = document.getElementById('allianceNameInput').value.trim().toUpperCase();
            if(name) {
                myCountry.alliance = name;
                saveGame();
            }
        });
        document.getElementById('leaveAllianceBtn').addEventListener('click', () => {
            myCountry.alliance = null;
            saveGame();
        });

        // --- DRAPEAU ---
        const canvas = document.getElementById('flagCanvas');
        const ctx = canvas.getContext('2d');
        const pW = canvas.width / FLAG_COLS;
        const pH = canvas.height / FLAG_ROWS;
        let currentFlag = [];

        function loadFlag(json) {
            try { currentFlag = JSON.parse(json); } catch(e) { currentFlag = []; }
            drawFlag();
        }

        function drawFlag() {
            for(let r=0; r<FLAG_ROWS; r++) {
                for(let c=0; c<FLAG_COLS; c++) {
                    ctx.fillStyle = currentFlag[r*FLAG_COLS + c] || '#fff';
                    ctx.fillRect(c*pW, r*pH, pW, pH);
                    ctx.strokeStyle = '#eee';
                    ctx.strokeRect(c*pW, r*pH, pW, pH);
                }
            }
        }

        // Draw Interaction
        canvas.addEventListener('pointerdown', paint);
        canvas.addEventListener('pointermove', (e) => { if(e.buttons) paint(e); });

        function paint(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const c = Math.floor(x / pW);
            const r = Math.floor(y / pH);
            if(c>=0 && c<FLAG_COLS && r>=0 && r<FLAG_ROWS) {
                currentFlag[r*FLAG_COLS + c] = document.getElementById('colorPicker').value;
                drawFlag();
            }
        }

        document.getElementById('saveFlagBtn').addEventListener('click', () => {
            myCountry.flag = JSON.stringify(currentFlag);
            saveGame();
            feedback("Drapeau sauvegard√© !");
        });
        document.getElementById('clearFlagBtn').addEventListener('click', () => {
            currentFlag.fill('#ffffff');
            drawFlag();
        });
        
        function drawTinyFlag(cnv, json) {
            const cx = cnv.getContext('2d');
            const w = cnv.width / FLAG_COLS;
            const h = cnv.height / FLAG_ROWS;
            let f = [];
            try { f = JSON.parse(json); } catch(e){}
            for(let i=0; i<f.length; i++) {
                cx.fillStyle = f[i] || '#fff';
                cx.fillRect((i%FLAG_COLS)*w, Math.floor(i/FLAG_COLS)*h, w, h);
            }
        }

        function feedback(txt) {
            els.feedback.textContent = txt;
            setTimeout(() => els.feedback.textContent = '', 3000);
        }

        // --- START ---
        els.status.textContent = "Mode Solo/Vercel Activ√©";
        els.status.className = "mt-2 inline-block px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-bold";
        loadGame();

    </script>
</body>
</html>


