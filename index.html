<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoSim 2025: Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Chakra+Petch:wght@400;600;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #0f172a; color: #e2e8f0; user-select: none; }
        h1, h2, h3, .font-military { font-family: 'Black Ops One', cursive; }
        .font-tech { font-family: 'Chakra Petch', sans-serif; }
        
        /* UI Elements */
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        .btn { transition: all 0.2s; transform: scale(1); cursor: pointer; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: linear-gradient(to bottom, #2563eb, #1d4ed8); border-bottom: 4px solid #1e3a8a; }
        .btn-danger { background: linear-gradient(to bottom, #dc2626, #b91c1c); border-bottom: 4px solid #7f1d1d; }
        .btn-success { background: linear-gradient(to bottom, #16a34a, #15803d); border-bottom: 4px solid #14532d; }
        
        /* Stats Bars */
        .stat-bar { height: 12px; border-radius: 4px; overflow: hidden; background-color: #0f172a; border: 1px solid #475569; }
        .stat-bar-fill { height: 100%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Canvas */
        #editorCanvas, #menuFlagCanvas { image-rendering: pixelated; border: 2px solid #475569; cursor: crosshair; background: #000; touch-action: none; }
        
        /* Animations */
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 5px #3b82f6; } 50% { box-shadow: 0 0 20px #3b82f6; } }
        .glow { animation: pulse-glow 2s infinite; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- ==================== CONFIGURATION GLOBALE ==================== -->
    <script>
        const FLAG_COLS = 15;
        const FLAG_ROWS = 10;
        const MAX_ACTIONS_PER_TURN = 3;
        const STORAGE_KEY = 'geosim_ultimate_profile_v1';
        const SOLO_SAVE_KEY = 'geosim_ultimate_solo_save_v1';

        // Profil par d√©faut
        let profile = {
            name: "Nation " + Math.floor(Math.random()*1000),
            flag: new Array(FLAG_COLS * FLAG_ROWS).fill('#ffffff')
        };
        
        let gameState = { players: {}, logs: [], turn: 0 }; // Utilis√© par Solo et Multi
        let isMultiplayer = false;
        let myPeerId = 'me'; // Par d√©faut pour le mode solo

        // Initialiser apr√®s le chargement du DOM
        document.addEventListener('DOMContentLoaded', () => {
            loadProfile();
            renderMenuFlag();
        });


        function loadProfile() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if(saved) {
                const parsed = JSON.parse(saved);
                profile.name = parsed.name || profile.name;
                profile.flag = parsed.flag || profile.flag;
            }
            const nameInput = document.getElementById('globalNameInput');
            if(nameInput) nameInput.value = profile.name;
        }

        function saveProfile() {
            profile.name = document.getElementById('globalNameInput').value || "Nation Inconnue";
            localStorage.setItem(STORAGE_KEY, JSON.stringify(profile));
            renderMenuFlag();
        }

        // --- NAVIGATION ---
        function hideAllScreens() {
            ['screen-menu', 'screen-solo', 'screen-multi-lobby', 'screen-multi-game', 'screen-editor'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }
        
        // CORRECTION: Assure la destruction du peer et le retour au menu principal.
        function goHome() {
            if(multiPeer) { multiPeer.destroy(); multiPeer = null; }
            multiConnections = [];
            isHost = false;
            myPeerId = 'me';
            isMultiplayer = false;
            gameState = { players: {}, logs: [], turn: 0 }; // R√©initialiser l'√©tat
            
            hideAllScreens();
            document.getElementById('screen-menu').classList.remove('hidden');
            renderMenuFlag();
        }

        // ==================== √âDITEUR DE DRAPEAU ====================
        let editorCanvas, eCtx;
        let tempFlag = [];

        function openEditor() {
            editorCanvas = document.getElementById('editorCanvas');
            eCtx = editorCanvas.getContext('2d');
            
            tempFlag = [...profile.flag];
            drawEditor();
            hideAllScreens();
            document.getElementById('screen-editor').classList.remove('hidden');
        }

        function closeEditor(save) {
            if(save) {
                profile.flag = [...tempFlag];
                saveProfile();
            }
            // Retour au menu principal apr√®s √©dition
            hideAllScreens();
            document.getElementById('screen-menu').classList.remove('hidden');
            renderMenuFlag();
        }

        function drawEditor() {
            if(!eCtx) return;
            const pW = editorCanvas.width / FLAG_COLS;
            const pH = editorCanvas.height / FLAG_ROWS;
            eCtx.clearRect(0, 0, editorCanvas.width, editorCanvas.height);
            for(let i=0; i<tempFlag.length; i++) {
                const c = i % FLAG_COLS;
                const r = Math.floor(i / FLAG_COLS);
                eCtx.fillStyle = tempFlag[i];
                eCtx.fillRect(c*pW, r*pH, pW, pH);
                eCtx.strokeStyle = '#333';
                eCtx.strokeRect(c*pW, r*pH, pW, pH);
            }
        }

        let isDrawing = false;
        let lastPos = {x: -1, y: -1};

        // Fonction pour g√©rer les coordonn√©es de dessin (compatible souris/touch)
        function getCanvasCoords(e) {
            const rect = editorCanvas.getBoundingClientRect();
            let clientX, clientY;

            if (e.touches) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            const x = Math.floor((clientX - rect.left) / (rect.width/FLAG_COLS));
            const y = Math.floor((clientY - rect.top) / (rect.height/FLAG_ROWS));
            return {x, y};
        }

        function drawPixel(e) {
            e.preventDefault(); // Emp√™che le scroll mobile
            if(!isDrawing) return;
            
            const {x, y} = getCanvasCoords(e);

            if(x>=0 && x<FLAG_COLS && y>=0 && y<FLAG_ROWS && (x !== lastPos.x || y !== lastPos.y)) {
                tempFlag[y*FLAG_COLS+x] = document.getElementById('editorColor').value;
                drawEditor();
                lastPos = {x, y};
            }
        }
        
        document.addEventListener('pointerdown', (e) => {
            if (e.target.id === 'editorCanvas') {
                isDrawing = true;
                lastPos = {x: -1, y: -1};
                drawPixel(e);
            }
        });
        document.addEventListener('pointerup', () => isDrawing = false);
        document.addEventListener('pointermove', drawPixel);
        
        function clearEditor() { tempFlag.fill('#ffffff'); drawEditor(); }

        function renderMenuFlag() {
            const c = document.getElementById('menuFlagCanvas');
            if (!c) return;
            const ctx = c.getContext('2d');
            drawMiniFlag(ctx, profile.flag, c.width, c.height);
            document.getElementById('globalNameInput').value = profile.name;
        }

        function drawMiniFlag(ctx, flagData, w, h) {
            const pw = w / FLAG_COLS;
            const ph = h / FLAG_ROWS;
            for(let i=0; i<flagData.length; i++) {
                ctx.fillStyle = flagData[i] || '#ffffff';
                ctx.fillRect((i%FLAG_COLS)*pw, Math.floor(i/FLAG_COLS)*ph, pw, ph);
            }
        }

        // ==================== LOGIQUE ALLIANCE (Partag√©e) ====================
        function getPlayerById(id) {
            return gameState.players[id];
        }

        function createBot(level) {
            const botNames = [
                "Empire Alpha", "R√©publique Beta", "Union Gamma", "Royaume Delta", "Horde Omega",
                "Nation √âcarlate", "F√©d√©ration Azure", "Dominion de Jade", "Cit√© des Sables",
                "Gardiens de Glace", "Protectorat", "Junte Militaire", "√âtat Libre", "Coalition"
            ];
            const name = botNames[Math.floor(Math.random() * botNames.length)] + ' (IA ' + Math.floor(Math.random()*100) + ')';
            const id = 'bot_' + crypto.randomUUID().substring(0, 8);
            
            let stats = { eco: 20, mil: 20, spy: 20, stab: 20 };
            
            if (level === 'hard') {
                stats = { eco: 40 + Math.random()*10, mil: 40 + Math.random()*10, stab: 30 + Math.random()*10, spy: 40 + Math.random()*10 };
            } else if (level === 'normal') {
                stats = { eco: 25 + Math.random()*10, mil: 25 + Math.random()*10, stab: 20 + Math.random()*10, spy: 25 + Math.random()*10 };
            }

            return {
                id: id, 
                name: name,
                flag: new Array(FLAG_COLS * FLAG_ROWS).fill('#'+Math.floor(Math.random()*16777215).toString(16)),
                isBot: true, 
                hp: 100, 
                ...stats,
                actions: MAX_ACTIONS_PER_TURN,
                alliance: null,
                alliance_offer: null,
                bot_level: level
            };
        }

        // CORRECTION: Retir√© les appels √† render/broadcast car ils doivent √™tre g√©r√©s par la fonction appelante
        function addBots(count) {
            const levels = ['easy', 'normal', 'hard'];
            let added = 0;
            for(let i=0; i<count; i++) {
                const level = levels[i % levels.length]; // Cycle through levels
                const bot = createBot(level);
                gameState.players[bot.id] = bot;
                added++;
            }
            logGame(`Syst√®me : ${added} nouveaux √âtats IA ont rejoint la partie.`);
            return added; // Retourne le nombre ajout√©
        }

        function logGame(msg) {
            gameState.logs.push(msg);
            if (isMultiplayer && isHost) broadcastMulti();
        }

        // ==================== MOTEUR SOLO ====================
        
        function startSolo() {
            isMultiplayer = false;
            myPeerId = 'me';
            saveProfile(); 
            hideAllScreens();
            document.getElementById('screen-solo').classList.remove('hidden');
            
            const saved = localStorage.getItem(SOLO_SAVE_KEY);
            
            if(saved) {
                try {
                    gameState = JSON.parse(saved);
                    // Remplacer les donn√©es du joueur si elles existent
                    const me = gameState.players['me'];
                    if(me) { me.name = profile.name; me.flag = profile.flag; me.actions = MAX_ACTIONS_PER_TURN; }
                    logGame("Partie Solo charg√©e.");
                } catch(e) {
                    console.error("Erreur de chargement de la sauvegarde, nouvelle partie lanc√©e.", e);
                    initSoloGame();
                }
            } else {
                initSoloGame();
            }
            renderSoloUI(); // L'appel final qui assure que les bots sont affich√©s
        }

        function initSoloGame() {
            gameState.turn = 1;
            gameState.players = {};
            gameState.logs = [`Partie Solo d√©marr√©e. Tour 1.`];

            // Moi
            gameState.players['me'] = {
                id: 'me', name: profile.name, flag: profile.flag, isBot: false,
                hp: 100, eco: 20, mil: 20, stab: 20, spy: 20, 
                actions: MAX_ACTIONS_PER_TURN, alliance: null, alliance_offer: null
            };
            
            // 15 Bots mixtes
            addBots(15);
            localStorage.setItem(SOLO_SAVE_KEY, JSON.stringify(gameState));
        }

        function soloAction(type, targetId = null) {
            const me = gameState.players['me'];
            if(me.actions <= 0 || me.hp <= 0) { logGame("Vous n'avez plus d'action."); return; }
            
            let actionCost = 1;

            if(type === 'eco') { me.eco = Math.min(100, me.eco + 5); logGame("Investissement √âconomique (+5 ECO)"); }
            else if(type === 'mil') { me.mil = Math.min(100, me.mil + 5); logGame("Recrutement Militaire (+5 MIL)"); }
            else if(type === 'stab') { me.stab = Math.min(100, me.stab + 5); me.hp = Math.min(100, me.hp + 2); logGame("Campagne de Propagande (+5 STAB)"); }
            else if(type === 'spy') { me.spy = Math.min(100, me.spy + 5); logGame("Cr√©ation d'un R√©seau d'Espionnage (+5 SPY)"); }
            else if(type === 'attack') {
                if (!targetId) targetId = document.getElementById('soloTargetSelect').value;
                const target = getPlayerById(targetId);
                
                if(!target || target.alliance === me.alliance) {
                    logGame("Op√©ration annul√©e: Cible invalide ou alli√©e."); return;
                }
                const dmg = Math.max(5, Math.floor((me.mil * 0.5) - (target.mil * 0.2)));
                target.hp = Math.max(0, Math.floor(target.hp - dmg));
                logGame(`‚öîÔ∏è Attaque sur ${target.name}: -${Math.floor(dmg)} HP`);
                if(target.hp <= 0) { logGame(`üíÄ ${target.name} a √©t√© √©limin√©!`); target.alliance = null; }
            }
            else if(type === 'sabotage') {
                 if (!targetId) targetId = document.getElementById('soloTargetSelect').value;
                const target = getPlayerById(targetId);
                
                if(!target || target.alliance === me.alliance) {
                    logGame("Op√©ration annul√©e: Cible invalide ou alli√©e."); return;
                }

                const successRate = Math.min(0.9, me.spy / 100);
                if (Math.random() < successRate) {
                    const targets = ['eco', 'mil', 'stab'];
                    const statToSabotage = targets[Math.floor(Math.random() * targets.length)];
                    const loss = Math.max(5, Math.floor(Math.random() * 10) + 5); // Perte entre 5 et 14

                    target[statToSabotage] = Math.max(0, target[statToSabotage] - loss);
                    logGame(`üí£ SABOTAGE R√âUSSI contre ${target.name}: -${loss} ${statToSabotage.toUpperCase()} !`);
                } else {
                    me.stab = Math.max(0, me.stab - 5); // P√©nalit√© en cas d'√©chec
                    logGame(`üí£ SABOTAGE √âCHOU√â contre ${target.name}. L'op√©ration a √©t√© rep√©r√©e : -5 STAB.`);
                }
            }
            else if(type === 'add_bots_solo') {
                actionCost = 0; // Ne co√ªte pas d'action
                addBots(3);
            }

            me.actions = Math.max(0, me.actions - actionCost);
            renderSoloUI();
            localStorage.setItem(SOLO_SAVE_KEY, JSON.stringify(gameState));
        }

        function soloEndTurn() {
            const me = gameState.players['me'];
            
            // 1. Revenu et R√©initialisation
            const inc = 5 + Math.floor(me.eco/10);
            me.eco = Math.min(100, me.eco + inc);
            me.actions = MAX_ACTIONS_PER_TURN;
            gameState.turn++;
            logGame(`--- Tour ${gameState.turn} : D√©marr√© ---`);

            // 2. Bots AI
            Object.values(gameState.players).forEach(p => {
                if(p.isBot && p.hp > 0) botAI(p);
                if(p.hp > 0) p.actions = MAX_ACTIONS_PER_TURN; // R√©initialiser actions
            });
            
            // 3. Cleanup des morts
            gameState.players = Object.fromEntries(Object.entries(gameState.players).filter(([id, p]) => p.hp > 0));
            
            renderSoloUI();
            localStorage.setItem(SOLO_SAVE_KEY, JSON.stringify(gameState));
            checkVictory();
        }
        
        // Logique Alliance Solo
        function proposeAllianceSolo() {
            const me = gameState.players['me'];
            const tid = document.getElementById('soloTargetSelect').value;
            const target = getPlayerById(tid);
            
            if(!target || target.hp <= 0 || target.alliance === me.alliance) { logGame("Cible invalide ou d√©j√† alli√©e."); return; }
            
            if (me.actions <= 0) { logGame("Vous n'avez plus d'action."); return; }

            target.alliance_offer = me.id;
            me.actions--;
            logGame(`Diplomatie: Proposition d'alliance envoy√©e √† ${target.name}.`);
            renderSoloUI();
            localStorage.setItem(SOLO_SAVE_KEY, JSON.stringify(gameState));
        }
        
        function respondToAlliance(accept, targetId) {
            const me = gameState.players['me'];
            const proposer = getPlayerById(targetId);
            
            if (accept && proposer) {
                // Cr√©er un ID d'alliance bas√© sur les deux premi√®res lettres de chaque nom
                const allianceId = (me.name.substring(0,2) + proposer.name.substring(0,2)).toUpperCase() + crypto.randomUUID().substring(0, 2);
                me.alliance = allianceId;
                proposer.alliance = allianceId;
                logGame(`ü§ù ALLIANCE [${allianceId}]: Vous et ${proposer.name} avez form√© une alliance!`);
            } else {
                logGame(`Rejet: Vous avez refus√© la proposition de ${proposer.name}.`);
            }
            me.alliance_offer = null;
            renderSoloUI();
            localStorage.setItem(SOLO_SAVE_KEY, JSON.stringify(gameState));
        }
        
        function leaveAllianceSolo() {
            const me = gameState.players['me'];
            if(!me.alliance) return;
            const oldAllianceId = me.alliance;
            me.alliance = null;
            
            // Dissoudre l'alliance pour tous les membres dans le cas solo
            Object.values(gameState.players).forEach(p => {
                if(p.alliance === oldAllianceId) {
                    p.alliance = null;
                    if(p.id !== me.id) logGame(`üíî D√âSALLIANCE [${oldAllianceId}]: ${p.name} n'est plus alli√©.`);
                }
            });
            logGame(`üíî D√âSALLIANCE [${oldAllianceId}]: Votre alliance est dissoute.`);
            renderSoloUI();
            localStorage.setItem(SOLO_SAVE_KEY, JSON.stringify(gameState));
        }

        function checkVictory() {
            const livingPlayers = Object.values(gameState.players).filter(p => p.hp > 0 && !p.isBot);
            const nonAlliedEnemies = Object.values(gameState.players).filter(p => p.hp > 0 && p.alliance !== (gameState.players['me'] ? gameState.players['me'].alliance : null) && p.id !== 'me');
            
            if (nonAlliedEnemies.length === 0) {
                logGame(`üéâ VICTOIRE TOTALE! Vous ou votre alliance avez conquis le monde en ${gameState.turn} tours!`);
                // Afficher un message de victoire ici si n√©cessaire
            }
        }


        // ==================== BOT AI ====================
        function botAI(p) {
            // Logique Bot simplifi√©
            for(let i=0; i<MAX_ACTIONS_PER_TURN; i++) {
                if (p.hp <= 0) return;
                
                const targets = Object.values(gameState.players).filter(t => 
                    t.id !== p.id && t.hp > 0 && t.alliance !== p.alliance
                );
                
                // 1. R√©ponse Alliance
                if (p.alliance_offer) {
                    const accept = (p.bot_level === 'easy' && Math.random() < 0.9) || 
                                   (p.bot_level === 'normal' && Math.random() < 0.6) ||
                                   (p.bot_level === 'hard' && Math.random() < 0.3); // Hard bots sont m√©fiants
                    if (accept) {
                        const proposer = getPlayerById(p.alliance_offer);
                        const allianceId = (p.name.substring(0,2) + proposer.name.substring(0,2)).toUpperCase() + crypto.randomUUID().substring(0, 2);
                        p.alliance = allianceId;
                        proposer.alliance = allianceId;
                        logGame(`ü§ù ALLIANCE [${allianceId}]: ${p.name} s'allie avec ${proposer.name}.`);
                    }
                    p.alliance_offer = null;
                    continue;
                }
                
                // 2. Priorit√©s d'Action
                if (p.hp < 40 || p.stab < 30) { 
                    p.stab = Math.min(100, p.stab + 5);
                    p.hp = Math.min(100, p.hp + 2);
                    continue;
                }
                if (p.mil < 30 || (p.bot_level === 'hard' && p.mil < 60)) { 
                    p.mil = Math.min(100, p.mil + 5);
                    continue;
                }
                if (p.eco < 30) { 
                    p.eco = Math.min(100, p.eco + 5);
                    continue;
                }
                if (p.spy < 20 || (p.bot_level === 'hard' && p.spy < 40)) { 
                    p.spy = Math.min(100, p.spy + 5);
                    continue;
                }

                // 3. Offensives (Attaque ou Sabotage)
                if (targets.length > 0) {
                    const target = targets.reduce((best, current) => current.hp < best.hp ? current : best, targets[0]);
                    
                    if (p.mil > 60 && Math.random() > 0.5) { // Attaque frontale
                        const dmg = Math.max(5, Math.floor((p.mil * 0.5) - (target.mil * 0.2)));
                        target.hp = Math.max(0, Math.floor(target.hp - dmg));
                        logGame(`‚öîÔ∏è ${p.name} attaque ${target.name}.`);
                        if(target.hp <= 0) { logGame(`üíÄ ${target.name} a √©t√© √©limin√©!`); target.alliance = null; }
                        continue;
                    }
                    
                    if (p.spy > 40 && Math.random() > 0.5) { // Sabotage
                        const successRate = Math.min(0.9, p.spy / 100);
                        if (Math.random() < successRate) {
                            const stats = ['eco', 'mil', 'stab'];
                            const statToSabotage = stats[Math.floor(Math.random() * stats.length)];
                            const loss = Math.max(5, Math.floor(Math.random() * 10) + 5);
                            target[statToSabotage] = Math.max(0, target[statToSabotage] - loss);
                            logGame(`üí£ ${p.name} SABOTE ${target.name}: -${loss} ${statToSabotage.toUpperCase()}.`);
                        }
                        continue;
                    }
                }
                
                // 4. Par d√©faut: Investir
                p.eco = Math.min(100, p.eco + 5);
            }
        }
        // ==================== FIN MOTEUR SOLO ====================

        // --- UI RENDER (SOLO) ---
        
        function renderSoloUI() {
            const me = gameState.players['me'];
            if (!me) return;

            document.getElementById('soloHeaderName').textContent = me.name + (me.alliance ? ` [Alliance: ${me.alliance}]` : "");
            document.getElementById('soloTurn').textContent = gameState.turn;
            document.getElementById('soloHpText').textContent = me.hp + '%';
            document.getElementById('soloHpBar').style.width = me.hp + '%';
            document.getElementById('soloHpBar').style.backgroundColor = me.hp < 30 ? '#dc2626' : (me.hp < 70 ? '#f59e0b' : '#16a34a');
            
            document.getElementById('soloEcoVal').textContent = Math.floor(me.eco); document.getElementById('soloEcoBar').style.width = me.eco + '%';
            document.getElementById('soloMilVal').textContent = Math.floor(me.mil); document.getElementById('soloMilBar').style.width = me.mil + '%';
            document.getElementById('soloStabVal').textContent = Math.floor(me.stab); document.getElementById('soloStabBar').style.width = me.stab + '%';
            document.getElementById('soloSpyVal').textContent = Math.floor(me.spy); document.getElementById('soloSpyBar').style.width = me.spy + '%';
            
            document.getElementById('soloActions').textContent = me.actions + ` / ${MAX_ACTIONS_PER_TURN} Actions`;
            const btns = document.querySelectorAll('#screen-solo button.btn');
            btns.forEach(b => { 
                if(!b.id.includes('alliance') && !b.id.includes('addbot')) {
                    b.disabled = me.actions<=0 || me.hp <= 0; 
                    b.classList.toggle('opacity-50', me.actions<=0 || me.hp <= 0); 
                }
            });
            
            // Log
            const logDiv = document.getElementById('soloLog');
            logDiv.innerHTML = gameState.logs.slice(-10).map(l => `<div>> ${l}</div>`).join('');
            logDiv.scrollTop = logDiv.scrollHeight;

            const list = document.getElementById('soloRanking');
            const sel = document.getElementById('soloTargetSelect');
            list.innerHTML = ''; sel.innerHTML = '';
            
            // Alliance UI
            const allianceArea = document.getElementById('soloAllianceControls');
            allianceArea.innerHTML = '';
            
            if (me.alliance_offer) {
                const proposer = getPlayerById(me.alliance_offer);
                if (proposer) {
                     allianceArea.innerHTML = `
                        <div class="p-2 text-center text-yellow-300">
                            Offre d'Alliance de <b>${proposer.name}</b>.
                            <button onclick="respondToAlliance(true, '${proposer.id}')" class="btn btn-success px-2 py-1 ml-2 rounded text-xs">Accepter</button>
                            <button onclick="respondToAlliance(false, '${proposer.id}')" class="btn btn-danger px-2 py-1 ml-1 rounded text-xs">Refuser</button>
                        </div>
                    `;
                }
            } else if (me.alliance) {
                 allianceArea.innerHTML = `<button onclick="leaveAllianceSolo()" class="btn btn-danger w-full py-2 rounded text-sm">Quitter Alliance [${me.alliance}]</button>`;
            } else {
                allianceArea.innerHTML = `<button onclick="proposeAllianceSolo()" class="btn btn-primary w-full py-2 rounded text-sm" ${me.actions <= 0 ? 'disabled' : ''}>Proposer Alliance</button>`;
            }

            // Players
            Object.values(gameState.players).sort((a,b) => b.hp - a.hp).forEach(p => {
                const isMe = p.id === 'me';
                const div = document.createElement('div');
                div.className = `p-2 flex items-center gap-2 ${isMe ? 'bg-blue-900/30' : ''}`;
                
                const cvs = document.createElement('canvas');
                cvs.width = 30; cvs.height = 20;
                drawMiniFlag(cvs.getContext('2d'), p.flag, 30, 20);
                
                div.appendChild(cvs);
                let text = p.name;
                if (p.alliance) text += ` <span class="text-green-500 font-mono text-xs ml-1">[A:${p.alliance}]</span>`;
                if (p.isBot) text += ` <span class="text-red-300 text-xs ml-1">(${p.bot_level.toUpperCase()})</span>`;

                div.innerHTML += `<div class="flex-1 text-sm font-bold ${p.hp<=0?'text-red-500 line-through':'text-white'}">${text}</div><div class="text-xs text-gray-400">${p.hp}% HP</div>`;
                list.appendChild(div);

                if(!isMe && p.hp > 0 && p.alliance !== me.alliance) {
                    const opt = document.createElement('option');
                    opt.value = p.id; 
                    opt.textContent = `‚öîÔ∏è ${p.name} (${p.hp}%)`;
                    sel.appendChild(opt);
                }
            });
            // S√©lection par d√©faut
            if (sel.options.length > 0 && sel.selectedIndex === -1) sel.selectedIndex = 0;
            
            // Vider la cible si aucun ennemi
            if (sel.options.length === 0) sel.innerHTML = '<option value="">(Pas de cible)</option>';
        }

        // ==================== MOTEUR MULTI (P2P) ====================
        let multiPeer = null;
        let multiConn = null;
        let multiConnections = [];
        let isHost = false;
        
        function openMultiLobby() {
            isMultiplayer = true;
            saveProfile();
            hideAllScreens();
            document.getElementById('screen-multi-lobby').classList.remove('hidden');
            document.getElementById('multiHostArea').classList.add('hidden');
            document.getElementById('multiJoinArea').classList.add('hidden');
        }

        function showJoinInput() {
            document.getElementById('multiJoinArea').classList.remove('hidden');
        }
        
        // Nouvelle fonction pour l'h√¥te pour lancer la partie apr√®s le lobby
        function startMultiGame() {
            if (!isHost || !multiPeer || !multiPeer.id) return;
            
            // Ajouter les bots au d√©marrage
            addBots(15); 
            
            // Initialisation de la partie
            gameState.turn = 1;
            Object.values(gameState.players).forEach(p => p.actions = MAX_ACTIONS_PER_TURN);

            logGame(`--- Tour ${gameState.turn} : Partie Lanc√©e ---`);

            // Transition vers l'√©cran de jeu
            document.getElementById('screen-multi-lobby').classList.add('hidden');
            document.getElementById('screen-multi-game').classList.remove('hidden');
            
            // Diffusion de l'√©tat initial √† tous
            broadcastMulti(); 
        }

        function initPeer(host) {
            isHost = host;
            const id = host ? 'GEO-' + Math.floor(Math.random()*10000) : null;
            
            if(multiPeer) multiPeer.destroy();
            
            multiPeer = new Peer(id);

            multiPeer.on('open', (id) => {
                myPeerId = id;
                if(isHost) {
                    // 1. Host Initialization (Reste dans le lobby)
                    gameState.players = {};
                    gameState.logs = [`H√¥te d√©marr√©. Code: ${id}`];
                    gameState.turn = 0; 
                    
                    // Ajouter l'h√¥te
                    gameState.players[id] = { id: id, name: profile.name, flag: profile.flag, isBot: false, hp: 100, eco: 20, mil: 20, stab: 20, spy: 20, actions: 0, alliance: null, alliance_offer: null }; 
                    
                    document.getElementById('multiHostArea').classList.remove('hidden');
                    document.getElementById('multiCodeDisplay').textContent = id;
                    document.getElementById('multiStatus').textContent = `En attente de joueurs... (${Object.keys(gameState.players).length} joueur(s))`;
                    
                    renderMultiUI(); 
                    
                } else {
                    // 2. Client connect
                    const hostId = document.getElementById('multiHostInput').value.trim();
                    if (!hostId) { logGame("Code h√¥te manquant."); multiPeer.destroy(); return; }
                    
                    multiConn = multiPeer.connect(hostId);
                    setupMultiConn(multiConn);
                    
                    // Le client attend l'√©tat de l'h√¥te
                    document.getElementById('screen-multi-lobby').classList.add('hidden');
                    document.getElementById('screen-multi-game').classList.remove('hidden');
                    // Rendu de l'UI vide en attendant
                    document.getElementById('multiMyName').textContent = profile.name + " (En attente...)";
                }
            });

            multiPeer.on('connection', (conn) => {
                if(isHost) {
                    setupMultiConn(conn);
                    multiConnections.push(conn);
                }
            });
            
            multiPeer.on('error', (err) => {
                logGame(`Erreur P2P: ${err.type}`);
                console.error("PeerJS Error:", err);
                goHome();
            });
        }

        function setupMultiConn(conn) {
            conn.on('open', () => {
                if(isHost) {
                    logGame(`H√¥te: Connexion √©tablie avec ${conn.peer}.`);
                    // Mise √† jour du statut dans le lobby
                    document.getElementById('multiStatus').textContent = `En attente de joueurs... (${Object.keys(gameState.players).length + 1} joueur(s))`;
                    
                } else {
                    // Client connect√© √† l'h√¥te
                    conn.send({ type: 'HELLO', name: profile.name, flag: profile.flag, id: myPeerId });
                    logGame(`Connect√© √† l'h√¥te. Envoi des infos...`);
                }
            });
            conn.on('data', (data) => handleMultiData(data, conn));
            conn.on('close', () => {
                if(isHost) {
                    // Remove connection and player
                    multiConnections = multiConnections.filter(c => c.peer !== conn.peer);
                    delete gameState.players[conn.peer];
                    logGame(`Syst√®me : ${conn.peer} a quitt√© la partie.`);
                    broadcastMulti();
                } else {
                    // Client disconnected
                    logGame("D√©connect√© de l'h√¥te.");
                    goHome();
                }
            });
        }

        function handleMultiData(data, conn) {
            if(isHost) {
                if(data.type === 'HELLO') {
                    // Client just joined, add player to state
                    gameState.players[conn.peer] = { id: conn.peer, name: data.name, flag: data.flag, isBot: false, hp: 100, eco: 20, mil: 20, stab: 20, spy: 20, actions: MAX_ACTIONS_PER_TURN, alliance: null, alliance_offer: null };
                    logGame(`H√¥te : Le joueur ${data.name} a rejoint.`);
                    
                    // Si le jeu a d√©j√† commenc√© (turn > 0), le nouveau joueur re√ßoit les actions
                    if (gameState.turn > 0) gameState.players[conn.peer].actions = MAX_ACTIONS_PER_TURN;
                    
                    broadcastMulti();
                } else if(data.type === 'ACTION') {
                    processMultiAction(conn.peer, data.action, data.payload);
                    broadcastMulti();
                }
            } else {
                if(data.type === 'STATE_UPDATE') {
                    gameState = data.state;
                    renderMultiUI();
                }
            }
        }

        function processMultiAction(id, type, payload) {
            const p = gameState.players[id];
            if(!p || p.hp <= 0 || gameState.turn === 0) return; // Ignore actions si le jeu n'a pas commenc√©
            
            // Actions de jeu (co√ªt 1 action)
            if(['eco', 'mil', 'spy', 'attack', 'sabotage'].includes(type) && p.actions <= 0) { 
                logGame(`ACTION REJET√âE: ${p.name} n'a plus d'actions.`); return; 
            }
            
            if(type === 'eco') { p.eco = Math.min(100, p.eco+5); p.actions--; logGame(`${p.name} investit.`); }
            else if(type === 'mil') { p.mil = Math.min(100, p.mil+5); p.actions--; logGame(`${p.name} recrute.`); }
            else if(type === 'spy') { p.spy = Math.min(100, p.spy+5); p.actions--; logGame(`${p.name} forme des espions.`); }
            
            else if(type === 'attack') {
                const t = gameState.players[payload.target];
                if(!t || t.alliance === p.alliance) { logGame(`ACTION REJET√âE: ${p.name} ne peut pas attaquer ${t.name}.`); return; }
                const dmg = Math.max(5, Math.floor((p.mil*0.6) - (t.mil*0.2)));
                t.hp = Math.max(0, Math.floor(t.hp - dmg));
                logGame(`‚öîÔ∏è ${p.name} attaque ${t.name}: -${Math.floor(dmg)} HP`);
                if(t.hp <= 0) { logGame(`üíÄ ${t.name} a √©t√© √©limin√©!`); t.alliance = null; }
                p.actions--;
            }
            else if(type === 'sabotage') {
                const t = gameState.players[payload.target];
                if(!t || t.alliance === p.alliance) { logGame(`ACTION REJET√âE: ${p.name} ne peut pas saboter ${t.name}.`); return; }

                const successRate = Math.min(0.9, p.spy / 100);
                if (Math.random() < successRate) {
                    const stats = ['eco', 'mil', 'stab'];
                    const statToSabotage = stats[Math.floor(Math.random() * stats.length)];
                    const loss = Math.max(5, Math.floor(Math.random() * 10) + 5); 
                    t[statToSabotage] = Math.max(0, t[statToSabotage] - loss);
                    logGame(`üí£ SABOTAGE R√âUSSI par ${p.name} contre ${t.name}: -${loss} ${statToSabotage.toUpperCase()}!`);
                } else {
                    p.stab = Math.max(0, p.stab - 5);
                    logGame(`üí£ SABOTAGE √âCHOU√â par ${p.name} contre ${t.name}: -5 STAB pour ${p.name}.`);
                }
                p.actions--;
            }
            
            // Actions d'Alliance (ne consomment pas d'action de jeu)
            else if(type === 'PROPOSE') {
                const target = getPlayerById(payload.target);
                if(target && target.hp > 0 && target.alliance !== p.alliance) {
                    target.alliance_offer = p.id;
                    logGame(`Diplomatie: Proposition envoy√©e de ${p.name} √† ${target.name}.`);
                }
            }
            else if(type === 'ACCEPT') {
                const proposer = getPlayerById(payload.proposer);
                if (proposer) {
                    const allianceId = (p.name.substring(0,2) + proposer.name.substring(0,2)).toUpperCase() + crypto.randomUUID().substring(0, 2);
                    p.alliance = allianceId;
                    proposer.alliance = allianceId;
                    p.alliance_offer = null;
                    logGame(`ü§ù ALLIANCE [${allianceId}]: ${p.name} et ${proposer.name} sont alli√©s!`);
                }
            }
            else if(type === 'REJECT') { p.alliance_offer = null; }
            else if(type === 'LEAVE') {
                const oldAllianceId = p.alliance;
                p.alliance = null;
                // D√©sallier les autres membres humains/bots
                Object.values(gameState.players).forEach(t => {
                    if (t.alliance === oldAllianceId && t.id !== p.id) {
                        t.alliance = null;
                        logGame(`üíî D√âSALLIANCE [${oldAllianceId}]: ${t.name} n'est plus alli√©.`);
                    }
                });
                logGame(`üíî D√âSALLIANCE [${oldAllianceId}]: ${p.name} a quitt√© son alliance.`);
            }
            // Add Bots (Host only)
            else if (type === 'ADD_BOTS' && isHost) { addBots(3); }
        }

        function broadcastMulti() {
            if (!isHost) return;
            
            // L'h√¥te fait avancer le jeu (bots et revenu)
            if (gameState.turn > 0) {
                // 1. Traitement AI pour les bots
                Object.values(gameState.players).forEach(p => {
                    if(p.isBot && p.hp > 0) botAI(p);
                });
            
                // 2. Revenus pour tout le monde et r√©initialisation des actions
                Object.values(gameState.players).forEach(p => {
                    if(p.hp > 0) {
                        const inc = 5 + Math.floor(p.eco/10);
                        p.eco = Math.min(100, p.eco + inc);
                        p.actions = MAX_ACTIONS_PER_TURN;
                    }
                });
                
                // 3. Passage au tour suivant
                gameState.turn++;
                logGame(`--- Tour ${gameState.turn} : D√©marr√© ---`);
            }
            
            // 4. Nettoyage des morts pour tout le monde
            gameState.players = Object.fromEntries(Object.entries(gameState.players).filter(([id, p]) => p.hp > 0));
            
            renderMultiUI(); 
            
            // 5. Envoi
            const msg = { type: 'STATE_UPDATE', state: gameState };
            multiConnections.forEach(c => c.send(msg));
            
            checkVictory();
        }
        
        // Envoi d'une action simple au jeu (Solo ou Multi)
        function gameSend(action) {
            const me = gameState.players[myPeerId];
            if(!me || me.actions <= 0 || me.hp <= 0) {
                // ADD_BOTS n'a pas besoin d'actions
                if (action !== 'ADD_BOTS' && me) logGame("Vous n'avez plus d'action.");
                else if (!me) logGame("Le jeu n'a pas encore d√©marr√©.");
                return;
            }
            
            if(isMultiplayer) {
                let payload = {};
                if(['attack', 'sabotage'].includes(action)) {
                    payload.target = document.getElementById('multiTargetSelect').value;
                    if(!payload.target) return;
                }
                
                if(isHost) {
                    processMultiAction(myPeerId, action, payload);
                    broadcastMulti(); // H√¥te diffuse apr√®s son action
                } else {
                    multiConn.send({ type: 'ACTION', action: action, payload: payload });
                }
            } else {
                // Solo
                if (action === 'ADD_BOTS') soloAction('add_bots_solo'); // Action sp√©ciale pour le solo
                else soloAction(action);
            }
        }
        
        // Actions d'Alliance Multi
        function multiAllianceSend(type, targetId) {
            const me = gameState.players[myPeerId];
            if(!me) return;
            
            let payload = {};
            if(type === 'PROPOSE') {
                payload.target = document.getElementById('multiTargetSelect').value;
                if(!payload.target) return;
            } else if (type === 'ACCEPT') {
                payload.proposer = targetId;
            }

            if(isHost) {
                processMultiAction(myPeerId, type, payload);
                broadcastMulti();
            } else {
                multiConn.send({ type: 'ACTION', action: type, payload: payload });
            }
        }

        // --- UI RENDER (MULTI) ---

        function renderMultiUI() {
            const me = gameState.players[myPeerId];
            
            // Rendu sp√©cifique au lobby (avant le lancement du jeu)
            if (isHost && gameState.turn === 0) {
                 document.getElementById('multiStatus').textContent = `En attente de joueurs... (${Object.keys(gameState.players).length} joueur(s))`;
                 // Le reste du rendu va suivre pour la liste des joueurs
            }

            if(!me) return;
            
            // Masquer les boutons d'action si le jeu n'est pas lanc√© (Tour 0)
            const gameRunning = gameState.turn > 0;
            const gameControls = document.getElementById('multiGameControls');
            if (gameControls) gameControls.classList.toggle('hidden', !gameRunning);
            
            document.getElementById('multiMyName').textContent = me.name + (me.alliance ? ` [Alliance: ${me.alliance}]` : "");
            
            if (gameRunning) {
                document.getElementById('multiHpBar').style.width = me.hp + '%';
                document.getElementById('multiHpBar').style.backgroundColor = me.hp < 30 ? '#dc2626' : (me.hp < 70 ? '#f59e0b' : '#16a34a');
                document.getElementById('multiEcoVal').textContent = Math.floor(me.eco);
                document.getElementById('multiMilVal').textContent = Math.floor(me.mil);
                document.getElementById('multiStabVal').textContent = Math.floor(me.stab);
                document.getElementById('multiSpyVal').textContent = Math.floor(me.spy);
                document.getElementById('multiActions').textContent = me.actions + ` / ${MAX_ACTIONS_PER_TURN} Actions`;
            } else {
                 document.getElementById('multiActions').textContent = `En attente...`;
            }

            // Boutons d'action
            const actionBtns = document.querySelectorAll('#screen-multi-game button[data-action]');
            actionBtns.forEach(b => { 
                b.disabled = me.actions <= 0 || me.hp <= 0 || !gameRunning; 
                b.classList.toggle('opacity-50', me.actions <= 0 || me.hp <= 0 || !gameRunning); 
            });

            // Log
            const logDiv = document.getElementById('multiLog');
            logDiv.innerHTML = gameState.logs.slice(-10).map(l => `<div>> ${l}</div>`).join('');
            logDiv.scrollTop = logDiv.scrollHeight;

            const list = document.getElementById('multiPlayerList');
            const sel = document.getElementById('multiTargetSelect');
            list.innerHTML = ''; sel.innerHTML = '';
            
            // Alliance UI Multi
            const allianceArea = document.getElementById('multiAllianceControls');
            allianceArea.innerHTML = '';
            
            if (me.alliance_offer) {
                const proposer = getPlayerById(me.alliance_offer);
                if (proposer) {
                     allianceArea.innerHTML = `
                        <div class="p-2 text-center text-yellow-300">
                            Offre de <b>${proposer.name}</b>.
                            <button onclick="multiAllianceSend('ACCEPT', '${proposer.id}')" class="btn btn-success px-2 py-1 ml-2 rounded text-xs">Accepter</button>
                            <button onclick="multiAllianceSend('REJECT')" class="btn btn-danger px-2 py-1 ml-1 rounded text-xs">Refuser</button>
                        </div>
                    `;
                }
            } else if (me.alliance) {
                 allianceArea.innerHTML = `<button onclick="multiAllianceSend('LEAVE')" class="btn btn-danger w-full py-2 rounded text-sm">Quitter Alliance [${me.alliance}]</button>`;
            } else {
                allianceArea.innerHTML = `<button onclick="multiAllianceSend('PROPOSE')" class="btn btn-primary w-full py-2 rounded text-sm" ${!gameRunning || me.actions <= 0 ? 'disabled' : ''}>Proposer Alliance</button>`;
            }
            
            // Player List
            Object.values(gameState.players).sort((a,b) => b.hp - a.hp).forEach(p => {
                const isMe = p.id === myPeerId;
                const div = document.createElement('div');
                div.className = `p-2 flex items-center gap-2 ${isMe ? 'bg-blue-900/30' : ''}`;
                
                const cvs = document.createElement('canvas');
                cvs.width = 30; cvs.height = 20;
                drawMiniFlag(cvs.getContext('2d'), p.flag, 30, 20);
                
                div.appendChild(cvs);
                let text = p.name;
                if (p.alliance) text += ` <span class="text-green-500 font-mono text-xs ml-1">[A:${p.alliance}]</span>`;
                if (p.isBot) text += ` <span class="text-red-300 text-xs ml-1">(${p.bot_level ? p.bot_level.toUpperCase() : 'IA'})</span>`;

                div.innerHTML += `<div class="flex-1 text-sm font-bold ${p.hp<=0?'text-red-500 line-through':'text-white'}">${text}</div><div class="text-xs text-gray-400">${p.hp}% HP</div>`;
                list.appendChild(div);

                if(!isMe && p.hp > 0 && p.alliance !== me.alliance) {
                    const opt = document.createElement('option');
                    opt.value = p.id; 
                    opt.textContent = `‚öîÔ∏è ${p.name} (${p.hp}%)`;
                    sel.appendChild(opt);
                }
            });
            // S√©lection par d√©faut
            if (sel.options.length > 0 && sel.selectedIndex === -1) sel.selectedIndex = 0;
            if (sel.options.length === 0) sel.innerHTML = '<option value="">(Pas de cible)</option>';
            
            // Bouton pour ajouter des bots (H√¥te seulement)
            const addBotBtn = document.getElementById('multiAddBotBtn');
            if (isHost && gameRunning) {
                addBotBtn.classList.remove('hidden');
            } else if (addBotBtn) {
                addBotBtn.classList.add('hidden');
            }
        }
        
    </script>

    <!-- ==================== MENU PRINCIPAL ==================== -->
    <div id="screen-menu" class="flex-1 flex flex-col items-center justify-center p-4 bg-slate-900 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
        <div class="max-w-md w-full text-center space-y-8">
            <div>
                <h1 class="text-6xl text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300 filter drop-shadow-lg">GEOSIM</h1>
                <p class="text-gray-400 tracking-[0.5em] text-sm mt-2">GLOBAL WARFARE</p>
            </div>

            <!-- Carte Profil (Sauvegard√©) -->
            <div class="card p-6 border-t-4 border-blue-500">
                <h3 class="text-left text-xs text-blue-400 font-bold mb-2">IDENTIT√â NATIONALE</h3>
                <div class="flex items-center gap-4 mb-4">
                    <canvas id="menuFlagCanvas" width="90" height="60" class="border border-gray-600 shadow-lg"></canvas>
                    <input type="text" id="globalNameInput" onchange="saveProfile()" class="flex-1 bg-slate-800 border border-slate-600 text-white font-bold text-lg p-2 rounded focus:border-blue-500 outline-none" placeholder="Nom du Pays">
                </div>
                <!-- CORRECTION: Le bouton modifier le drapeau fonctionne maintenant -->
                <button onclick="openEditor()" class="text-xs text-gray-400 hover:text-white underline">Modifier le Drapeau</button>
            </div>

            <!-- Choix du Mode -->
            <div class="space-y-4">
                <button onclick="startSolo()" class="btn btn-primary w-full py-4 rounded-xl text-xl font-black font-tech shadow-xl glow group relative overflow-hidden">
                    <span class="relative z-10">CAMPAGNE SOLO üë§</span>
                </button>
                
                <button onclick="openMultiLobby()" class="btn btn-success w-full py-4 rounded-xl text-xl font-black font-tech shadow-xl group">
                    MULTIJOUEUR (P2P) üåê
                </button>
            </div>
            
            <p class="text-xs text-gray-600">v3.3 Fixes</p>
        </div>
    </div>

    <!-- ==================== √âDITEUR DRAPEAU (MODAL) ==================== -->
    <div id="screen-editor" class="hidden fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4">
        <div class="bg-slate-800 p-6 rounded-xl border border-slate-600 max-w-sm w-full text-center">
            <h2 class="text-2xl mb-4 text-white">√âditeur Pixel (15x10)</h2>
            <canvas id="editorCanvas" width="300" height="200" class="mx-auto mb-4 w-full shadow-2xl"></canvas>
            <div class="flex justify-center gap-2 mb-4">
                <input type="color" id="editorColor" value="#ff0000" class="h-10 w-10 rounded border-0 cursor-pointer">
                <button onclick="clearEditor()" class="btn bg-gray-600 px-4 py-2 rounded text-white text-sm">Effacer</button>
            </div>
            <div class="flex gap-2">
                <button onclick="closeEditor(false)" class="flex-1 py-3 rounded text-gray-400 hover:bg-slate-700">Annuler</button>
                <button onclick="closeEditor(true)" class="flex-1 btn btn-success py-3 rounded text-white font-bold">SAUVEGARDER</button>
            </div>
        </div>
    </div>

    <!-- ==================== UI SOLO ==================== -->
    <div id="screen-solo" class="hidden flex-1 flex flex-col p-2 md:p-4 max-w-6xl mx-auto w-full">
        <header class="flex justify-between items-center mb-4 bg-slate-800 p-3 rounded border border-slate-700">
            <div>
                <!-- Le bouton Retour Menu Solo est maintenant fiable gr√¢ce √† la fonction goHome corrig√©e -->
                <button onclick="goHome()" class="text-xs text-gray-500 hover:text-white mb-1">‚óÄ Retour Menu</button>
                <h2 id="soloHeaderName" class="text-xl font-bold text-blue-400">Mon Pays</h2>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-400">Tour <span id="soloTurn">1</span></div>
                <!-- Utilise une action solo non co√ªteuse pour ajouter des bots -->
                <button onclick="soloAction('add_bots_solo')" class="btn bg-red-900/50 px-2 py-1 rounded text-xs mt-1 hover:bg-red-900">AJOUTER BOTS</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-full">
            <!-- Stats Solo -->
            <div class="card p-4 space-y-4 lg:col-span-1">
                <div class="flex justify-between items-end">
                    <span class="text-gray-400 text-xs uppercase font-bold">Sant√© Nationale</span>
                    <span id="soloHpText" class="text-2xl font-black text-red-500">100%</span>
                </div>
                <div class="h-4 stat-bar">
                    <div id="soloHpBar" class="stat-bar-fill" style="width: 100%"></div>
                </div>
                
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between"><span>üí∞ √âconomie</span> <span id="soloEcoVal">20</span></div>
                    <div class="stat-bar"><div id="soloEcoBar" class="stat-bar-fill bg-blue-600" style="width: 20%"></div></div>
                    
                    <div class="flex justify-between"><span>üõ°Ô∏è Arm√©e</span> <span id="soloMilVal">20</span></div>
                    <div class="stat-bar"><div id="soloMilBar" class="stat-bar-fill bg-yellow-600" style="width: 20%"></div></div>
                    
                    <div class="flex justify-between"><span>‚öñÔ∏è Stabilit√©</span> <span id="soloStabVal">20</span></div>
                    <div class="stat-bar"><div id="soloStabBar" class="stat-bar-fill bg-green-600" style="width: 20%"></div></div>

                     <div class="flex justify-between"><span>üëÅÔ∏è Espionnage</span> <span id="soloSpyVal">20</span></div>
                    <div class="stat-bar"><div id="soloSpyBar" class="stat-bar-fill bg-purple-600" style="width: 20%"></div></div>
                </div>
                <div id="soloLog" class="h-32 bg-black/50 rounded p-2 text-xs font-mono overflow-y-auto text-gray-400 border border-slate-700"></div>
            </div>

            <!-- Actions Solo -->
            <div class="card p-4 lg:col-span-1 flex flex-col gap-2">
                <div class="text-center mb-2">
                    <span id="soloActions" class="bg-blue-900 text-blue-200 px-2 py-1 rounded text-sm font-bold">3 / 3 Actions</span>
                </div>
                <button onclick="soloAction('eco')" data-action="eco" class="btn bg-slate-700 hover:bg-slate-600 p-3 rounded text-left border-l-4 border-blue-500">üèóÔ∏è Investir</button>
                <button onclick="soloAction('mil')" data-action="mil" class="btn bg-slate-700 hover:bg-slate-600 p-3 rounded text-left border-l-4 border-yellow-500">üõ°Ô∏è Recruter</button>
                <button onclick="soloAction('stab')" data-action="stab" class="btn bg-slate-700 hover:bg-slate-600 p-3 rounded text-left border-l-4 border-green-500">üì¢ Propagande</button>
                <button onclick="soloAction('spy')" data-action="spy" class="btn bg-slate-700 hover:bg-slate-600 p-3 rounded text-left border-l-4 border-purple-500">üëÅÔ∏è Espionner</button>
                
                <div id="soloAllianceControls" class="mt-4 pt-2 border-t border-slate-700">
                    <!-- Alliance controls here -->
                </div>
                
                <div class="mt-2 pt-2 border-t border-slate-700">
                    <select id="soloTargetSelect" class="w-full bg-slate-900 p-2 rounded mb-2 text-sm border border-slate-600"></select>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="soloAction('attack')" data-action="attack" class="btn btn-danger w-full py-3 rounded font-bold">ATTAQUER</button>
                        <button onclick="soloAction('sabotage')" data-action="sabotage" class="btn bg-red-800 w-full py-3 rounded font-bold hover:bg-red-700">üí£ SABOTER</button>
                    </div>
                </div>
                
                <button onclick="soloEndTurn()" class="btn bg-slate-800 w-full py-3 rounded font-bold mt-auto border border-slate-600 hover:bg-slate-700">Fin du Tour üåô</button>
            </div>

            <!-- Classement Solo -->
            <div class="card p-0 overflow-hidden lg:col-span-1 flex flex-col">
                <div class="bg-slate-800 p-2 text-xs font-bold text-center">CLASSEMENT MONDIAL</div>
                <div id="soloRanking" class="flex-1 overflow-y-auto divide-y divide-slate-700 bg-slate-900/50"></div>
            </div>
        </div>
    </div>

    <!-- ==================== UI MULTI (LOBBY & JEU) ==================== -->
    <div id="screen-multi-lobby" class="hidden flex-1 flex flex-col items-center justify-center p-4 bg-slate-900">
        <div class="max-w-md w-full card p-8 border-blue-500 border-2">
            <button onclick="goHome()" class="mb-4 text-xs text-gray-500 hover:text-white">‚óÄ Retour</button>
            <h2 class="text-3xl text-center mb-6 text-white font-military">QUARTIER G√âN√âRAL P2P</h2>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button onclick="initPeer(true)" class="btn btn-primary p-4 rounded flex flex-col items-center gap-2">
                    <span class="text-2xl">üëë</span><span class="font-bold">CR√âER (H√¥te)</span>
                </button>
                <button onclick="showJoinInput()" class="btn btn-success p-4 rounded flex flex-col items-center gap-2">
                    <span class="text-2xl">‚öîÔ∏è</span><span class="font-bold">REJOINDRE</span>
                </button>
            </div>

            <div id="multiJoinArea" class="hidden mb-4">
                <div class="flex gap-2">
                    <input type="text" id="multiHostInput" class="flex-1 bg-slate-800 border border-slate-600 p-3 rounded text-center font-mono uppercase" placeholder="CODE DE L'H√îTE">
                    <button onclick="initPeer(false)" class="bg-green-600 px-4 rounded font-bold">GO</button>
                </div>
            </div>
            
            <!-- CORRECTION: Ajout du bouton Lancer la Partie pour l'h√¥te -->
            <div id="multiHostArea" class="hidden text-center bg-slate-800 p-4 rounded border border-dashed border-slate-600">
                <p class="text-gray-400 text-xs mb-2">CODE √Ä PARTAGER :</p>
                <div id="multiCodeDisplay" class="text-3xl font-mono font-bold text-blue-400 tracking-widest select-all cursor-pointer mb-2">...</div>
                <p id="multiStatus" class="text-xs text-yellow-500 animate-pulse">En attente de joueurs...</p>
                <button onclick="startMultiGame()" class="btn btn-primary w-full mt-4 py-2 rounded font-bold">LANCER LA PARTIE</button>
            </div>
        </div>
    </div>

    <div id="screen-multi-game" class="hidden flex-1 flex flex-col p-2 md:p-4 max-w-6xl mx-auto w-full">
        <header class="flex justify-between items-center mb-4 bg-slate-800 p-3 rounded border border-blue-900">
            <h2 class="text-xl font-bold text-blue-400 font-military">GUERRE P2P</h2>
            <!-- Ajout du bouton Quitter et r√©organisation de l'en-t√™te -->
            <div class="flex flex-col items-end">
                <button onclick="goHome()" class="text-xs text-red-500 hover:text-white underline mb-1">‚ùå Quitter la Partie</button>
                <div class="text-xs text-green-400 flex items-center gap-1">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> EN LIGNE
                </div>
                <button id="multiAddBotBtn" onclick="gameSend('ADD_BOTS')" class="btn bg-red-900/50 px-2 py-1 rounded text-xs mt-1 hover:bg-red-900 hidden">AJOUTER BOTS</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- Stats Multi -->
            <div class="card p-4 space-y-4 lg:col-span-1 border-l-4 border-blue-500">
                <h3 id="multiMyName" class="font-bold text-lg">Moi</h3>
                <div class="h-4 stat-bar">
                    <div id="multiHpBar" class="stat-bar-fill" style="width: 100%"></div>
                </div>
                <div class="grid grid-cols-4 gap-2 text-center text-xs">
                    <div class="bg-slate-800 p-2 rounded">üí∞ <span id="multiEcoVal">0</span></div>
                    <div class="bg-slate-800 p-2 rounded">üõ°Ô∏è <span id="multiMilVal">0</span></div>
                    <div class="bg-slate-800 p-2 rounded">‚öñÔ∏è <span id="multiStabVal">0</span></div>
                    <div class="bg-slate-800 p-2 rounded">üëÅÔ∏è <span id="multiSpyVal">0</span></div>
                </div>
                <div id="multiLog" class="h-32 bg-black/50 rounded p-2 text-xs font-mono overflow-y-auto text-green-400 border border-slate-700"></div>
            </div>

            <!-- Actions Multi -->
            <div id="multiGameControls" class="card p-4 lg:col-span-1 space-y-2">
                <div class="text-right mb-2"><span id="multiActions" class="text-xs font-bold bg-blue-900 px-2 py-1 rounded">Wait...</span></div>
                <button onclick="gameSend('eco')" data-action="eco" class="btn bg-slate-700 p-3 rounded w-full text-left border-l-4 border-blue-500">üèóÔ∏è Investir</button>
                <button onclick="gameSend('mil')" data-action="mil" class="btn bg-slate-700 p-3 rounded w-full text-left border-l-4 border-yellow-500">üõ°Ô∏è Recruter</button>
                <button onclick="gameSend('stab')" data-action="stab" class="btn bg-slate-700 p-3 rounded w-full text-left border-l-4 border-green-500">üì¢ Propagande</button>
                <button onclick="gameSend('spy')" data-action="spy" class="btn bg-slate-700 p-3 rounded w-full text-left border-l-4 border-purple-500">üëÅÔ∏è Espionner</button>
                
                <div id="multiAllianceControls" class="mt-4 pt-2 border-t border-slate-700">
                    <!-- Alliance controls here -->
                </div>

                <div class="mt-2 pt-2 border-t border-slate-700 bg-red-900/10 p-2 rounded">
                    <select id="multiTargetSelect" class="w-full bg-slate-900 p-2 rounded mb-2 text-sm border border-red-900"></select>
                    <div class="grid grid-cols-2 gap-2">
                         <button onclick="gameSend('attack')" data-action="attack" class="btn btn-danger w-full py-3 rounded font-bold shadow-lg">ATTAQUER</button>
                         <button onclick="gameSend('sabotage')" data-action="sabotage" class="btn bg-red-800 w-full py-3 rounded font-bold hover:bg-red-700">üí£ SABOTER</button>
                    </div>
                </div>
            </div>

            <!-- Liste Multi -->
            <div class="card p-0 lg:col-span-1 overflow-hidden">
                <div class="bg-slate-800 p-2 text-xs font-bold text-center uppercase">Forces en Pr√©sence</div>
                <div id="multiPlayerList" class="divide-y divide-slate-700"></div>
            </div>
        </div>
    </div>
</body>
</html>

